(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function t(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(o){if(o.ep)return;o.ep=!0;const s=t(o);fetch(o.href,s)}})();function an(i){const e=i.trim();if(e==="0")return{style:"none"};let t=e,n;t=t.replace(/(solid|dotted|dot-dot-dash|dot-dash|dashed|double-dash|double|bold-dash|bold|broad|wide|wave|none)/g,c=>(n=c,"")),n??="solid";let o;t=t.replace(/(\d+(px|em|%))/g,c=>(o=c,""));let s;if(o){const c=o.replace(/[^0-9]+/g,"");c!==""&&(s=c)}return t=t.replace(/\s+/g,""),{style:n,width:s,color:t===""?void 0:t}}function ct(i,e){for(const[t,n]of Object.entries(e)){if(t==="border"){const{style:o,width:s,color:r}=an(n);i.borderstyle=o,s!==void 0&&(i.borderwidth=s),r!==void 0&&(i.bordercolor=r);continue}if(t==="size"){const o=/^(\d+)\s*,\s*(\d+)\s*$/.exec(n.trim());if(!o)throw new Error(`Invalid size attribute: '${n}'`);const s=Math.abs(Math.trunc(Number(o[1]))),r=Math.abs(Math.trunc(Number(o[2])));i.columns=String(s),i.rows=String(r);continue}i[t]=n}}function ln(i){let e=i.trim();return e=e.replace(/^["'](.*)["']$/s,"$1"),e=e.replace(/\\([#"';\\])/g,"$1"),e=e.replace(/%7f/gi,""),e=e.replace(/%[^2-7][a-fA-F0-9]/g,""),e=e.replace(/%([2-7][a-fA-F0-9])/g,(t,n)=>String.fromCharCode(parseInt(n,16))),e}function Et(i){const e=i.trim();if(!e.startsWith("{")||!e.endsWith("}"))throw new Error(`Expected an attribute block like "{ a: b; }", got: ${i}`);const t=e.slice(1,-1).trim(),n=Object.create(null);if(!t)return n;for(const o of t.split(";")){const s=o.trim();if(!s)continue;const r=/^([^:=]+?)\s*[:=]\s*(.*?)\s*$/.exec(s);if(!r)throw new Error(`Invalid attribute entry: ${s}`);const c=r[1].trim().toLowerCase().replace(/-/g,""),f=ln(r[2]);n[c]=f}return n}const Ve={forward:0,front:0,left:-90,right:90,back:180},re={up:0,north:0,down:180,south:180,west:270,east:90,0:0,180:180,90:90,270:270},fn={east:90,west:270,north:0,south:180,up:0,down:180,back:270,left:270,right:90,front:90,forward:90},ke={north:"north",south:"south",east:"east",west:"west",up:"north",down:"south",0:"north",180:"south",90:"east",270:"west"};function hn(i){return ke[i.trim().toLowerCase()]}function Te(i){const e=i.trim().toLowerCase(),t=fn[e];if(t!==void 0)return t;const n=re[e];if(n!==void 0)return n;throw new Error(`Invalid parent flow: ${i}`)}function un(i,e){const t=e.trim().toLowerCase();if(/^(south|north|west|east|up|down|0|90|180|270)$/.test(t))return ke[t];const n=re[String(i)],o=Ve[t];if(n===void 0)throw new Error(`flowAsSide: ${String(i)},${e} results in undefined inflow`);if(o===void 0)throw new Error(`flowAsSide: ${String(i)},${e} results in undefined modifier`);let s=n+o;return s>=360&&(s-=360),ke[String(s)]}function dn(i,e){const t=e.trim().toLowerCase();if(/^(south|north|west|east|up|down|0|90|180|270)$/.test(t))return re[t];const n=re[String(i)],o=Ve[t];if(n===void 0)throw new Error(`flowAsDirection: ${String(i)},${e} results in undefined inflow`);if(o===void 0)throw new Error(`flowAsDirection: ${String(i)},${e} results in undefined modifier`);let s=n+o;for(;s>=360;)s-=360;for(;s<0;)s+=360;return s}class pn{constructor(e,t,n,o,s,r){this.id=e,this.from=t,this.to=n,this.leftOp=o,this.rightOp=s,this.label=r}attributes=Object.create(null);graph;group;bidirectional=!1;undirected=!1;cells=[];todo=!0;setAttributes(e){if(Object.prototype.hasOwnProperty.call(e,"class")){const t=e.class?.trim()??"";if(t!==""&&this.graph)for(const n of t.split(/[\s,]+/).filter(Boolean)){const o=this.graph.edgeClassAttributes.get(n.toLowerCase());o&&ct(this.attributes,o)}}ct(this.attributes,e)}rawAttribute(e){return this.attributes[e]}attribute(e){const t=this.attributes[e];if(t!==void 0)return t;if(e==="textwrap")return this.graph?.graphAttributes.textwrap??"";if(e==="flow"){const n=this.resolvedAttribute("flow");return n!==""?n:"east"}return""}resolvedAttribute(e){const t=r=>r.trim().toLowerCase(),n=this.rawAttribute(e);if(n!==void 0&&t(n)!==""&&t(n)!=="inherit")return n;let o=this.group;for(;o;){const r=o.rawAttribute(e);if(r!==void 0&&t(r)!==""&&t(r)!=="inherit")return r;o=o.parent}const s=this.graph?.graphAttributes[e];return s!==void 0&&t(s)!==""&&t(s)!=="inherit"?s:""}labelText(){let e=this.rawAttribute("label")??this.label;if(e!==""){const t=this.resolvedAttribute("autolabel");if(t!==""){let n=t.trim();n=n.replace(/^name\s*,\s*/i,"");let o=Math.abs(Number(n)||0);if(o>99999&&(o=99999),e.length>o){let s=Math.trunc(o/2)-3;s<0&&(s=0),s===0?e=" ... ":e=e.slice(0,s)+" ... "+e.slice(e.length-s)}}}return e}flow(){const e=s=>s.trim().toLowerCase(),t=s=>{if(s===void 0)return;const r=e(s);if(!(r===""||r==="inherit"))return r};let n=t(this.rawAttribute("flow"));if(n===void 0&&(n=t(this.from.rawAttribute("flow"))),n===void 0){let s=this.group;for(;s;){const r=t(s.rawAttribute("flow"));if(r!==void 0){n=String(Te(r));break}s=s.parent}}if(n===void 0){const s=t(this.graph?.graphAttributes.flow);s!==void 0&&(n=String(Te(s)))}if(n===void 0&&(n="90"),n==="0"||n==="90"||n==="180"||n==="270")return Number(n);const o=this.from.flow();return dn(o,n)}edgeFlow(){const e=this.rawAttribute("flow");if(e===void 0)return;const t=e.trim().toLowerCase();if(!(t===""||t==="inherit"))return this.flow()}hasPorts(){return this.attribute("start")!==""||this.attribute("end")!==""}port(e){const t=this.attribute(e);if(!t)return[void 0,void 0];const[n,o]=t.split(/\s*,\s*/),s=o!==void 0&&o!==""?Number(o):void 0,r=hn(n);if(r)return[r,s];const c=this.from.flow();return[un(c,n),s]}clearCells(){this.cells=[]}addCell(e,t,n){if(n&&n.edge!==this&&(n=void 0),t&&typeof t!="number"&&t.edge!==this&&(t=void 0),!t&&n&&(t=n,n=void 0),t!==void 0){let o;if(typeof t=="number")o=t;else if(n){o=-1;for(let s=0;s<this.cells.length-1;s++){const r=this.cells[s],c=this.cells[s+1];if(r===t&&c===n||r===n&&c===t){o=s+1;break}}o===-1&&(o=this.cells.findIndex(s=>s===t),o=o===-1?this.cells.length:o+1)}else o=this.cells.findIndex(s=>s===t),o=o===-1?this.cells.length:o+1;this.cells.splice(o,0,e);return}this.cells.push(e)}}const rt=0,_=1,O=2,K=3,H=4,nt=5,Z=6,gt=7,wt=8,yt=9,mt=10,Se=11,Qt=12,Tt=13,Lt=14,Ne=15,gn=12,Q=256,at=512,X=1024,lt=2048,V=16,q=32,J=64,W=128,Y=4096,qe=8192,wn=4080,Gt=3840,Ft=240,B=15,ht=65520,Je=61440,ce=4095,de=0,pe=1,Xt=2,Yt=3,yn=J+V,mn=q+W,xn=_+J+X,bn=_+V+Q,vn=_+Q+X,En=O+at+lt,Vt=Qt+W+lt+Y,qt=Tt+q+at+Y,Jt=Ne+J+X+Y,Kt=Lt+V+Q+Y,kn={forward:0,front:0,left:-90,right:90,back:180},ae={up:0,north:0,down:180,south:180,west:270,east:90,0:0,90:90,180:180,270:270},$n={east:90,west:270,north:0,south:180,up:0,down:180,back:270,left:270,right:90,front:90,forward:90};function An(i,e){const t=e.trim().toLowerCase();if(/^(south|north|west|east|up|down|0|90|180|270)$/.test(t))return ae[t];const n=ae[String(i)],o=kn[t];if(n===void 0)throw new Error(`flowAsDirection: ${String(i)},${e} results in undefined inflow`);if(o===void 0)throw new Error(`flowAsDirection: ${String(i)},${e} results in undefined modifier`);let s=n+o;for(;s>=360;)s-=360;for(;s<0;)s+=360;return s}class $t{constructor(e,t,n){this.id=e,this.label=t,this.numericId=n}attributes=Object.create(null);numericId;graph;group;edgesById=new Map;origin;dx=0;dy=0;children=new Map;findGrandparent(){let e=this;const t=new Set;for(;e.origin&&e.origin!==e;){if(t.has(e.origin))throw new Error(`Detected loop in origin chain starting at '${this.id}'`);t.add(e.origin),e=e.origin}return e}findGrandparentWithOffset(){let e=this,t=0,n=0;const o=new Set;for(;e.origin&&e.origin!==e;){if(o.has(e.origin))throw new Error(`Detected loop in origin chain starting at '${this.id}'`);o.add(e.origin),t-=e.dx,n-=e.dy,e=e.origin}return[e,t,n]}x;y;cx;cy;rank;w;h;cache=Object.create(null);todo=!0;chain;chainNext;setAttributes(e){if(Object.prototype.hasOwnProperty.call(e,"class")){const t=e.class?.trim()??"";if(t!==""&&this.graph)for(const n of t.split(/[\s,]+/).filter(Boolean)){const o=this.graph.nodeClassAttributes.get(n.toLowerCase());o&&ct(this.attributes,o)}}if(ct(this.attributes,e),Object.prototype.hasOwnProperty.call(e,"origin")){const t=e.origin?.trim()??"";if(t!==""){if(!this.graph)throw new Error(`Cannot resolve origin '${t}' for node '${this.id}' without graph`);const n=this.graph.addNode(t);if(this.origin&&this.origin.children.delete(this.id),n.findGrandparent()===this)throw new Error(`Detected loop in origin-chain: tried to set origin of '${this.id}' to my own grandchild '${n.id}'`);this.origin=n,n.children.set(this.id,this)}}if(Object.prototype.hasOwnProperty.call(e,"offset")){const t=e.offset?.trim()??"";if(t!==""){const[n,o]=t.split(/\s*,\s*/),s=Math.trunc(Number(n)),r=Math.trunc(Number(o));if(s===0&&r===0)throw new Error(`Error in attribute: 'offset' is 0,0 in node ${this.id}`);this.dx=s,this.dy=r,this.attributes.offset=`${this.dx},${this.dy}`}}}rawAttribute(e){return this.attributes[e]}attribute(e){const t=this.attributes[e];return t!==void 0?t:e==="textwrap"?this.graph?.graphAttributes.textwrap??"":""}resolvedAttribute(e){const t=r=>r.trim().toLowerCase(),n=this.rawAttribute(e);if(n!==void 0&&t(n)!==""&&t(n)!=="inherit")return n;let o=this.group;for(;o;){const r=o.rawAttribute(e);if(r!==void 0&&t(r)!==""&&t(r)!=="inherit")return r;o=o.parent}const s=this.graph?.graphAttributes[e];return s!==void 0&&t(s)!==""&&t(s)!=="inherit"?s:""}labelText(){let e=this.rawAttribute("label");if(e===void 0&&(e=this.label),e===void 0&&(e=this.id),e===void 0)return"";if(e!==""){const t=this.resolvedAttribute("autolabel");if(t!==""){let n=t.trim();n=n.replace(/^name\s*,\s*/i,"");let o=Math.abs(Number(n)||0);if(o>99999&&(o=99999),e.length>o){let s=Math.trunc(o/2)-3;s<0&&(s=0),s===0?e=" ... ":e=e.slice(0,s)+" ... "+e.slice(e.length-s)}}}return e}addEdge(e){this.edgesById.set(e.id,e)}edges(){return[...this.edgesById.values()].sort((e,t)=>{const n=String(e.id),o=String(t.id);return n<o?-1:n>o?1:0})}predecessors(){const e=new Map;for(const t of this.edges())t.to===this&&e.set(String(t.from.numericId),t.from);return[...e.entries()].sort(([t],[n])=>t<n?-1:t>n?1:0).map(([,t])=>t)}successors(){const e=new Map;for(const t of this.edges())t.from===this&&e.set(String(t.to.numericId),t.to);return[...e.entries()].sort(([t],[n])=>t<n?-1:t>n?1:0).map(([,t])=>t)}hasPredecessors(){return this.predecessors().length}flow(){if("flow"in this.cache)return this.cache.flow;if("_flow"in this.cache){const e=this.parentFlowAbsolute(90)??90;return this.cache.flow=e,e}this.cache._flow=!0;try{const e=s=>s.trim().toLowerCase();let t=this.rawAttribute("flow");if(t=t!==void 0?t.trim():void 0,t===""&&(t=void 0),t===void 0||e(t)==="inherit"){const s=this.parentFlowAbsolute();if(s!==void 0)return this.cache.flow=s,s;t=void 0}if(t!==void 0){const s=e(t);if(s==="0"||s==="90"||s==="180"||s==="270"){const r=Number(s);return this.cache.flow=r,r}if(/^(south|north|east|west|up|down)$/.test(s)){const r=ae[s];return this.cache.flow=r,r}t=s}let n;for(const s of this.edges())if(s.from!==this&&s.to===this){n=s.flow();break}if(n===void 0)for(const s of this.edges()){const r=s.bidirectional?s.to:s.from;if(r!==this){n=r.flow();break}}n??=this.parentFlowAbsolute(90)??90,t??=String(n);const o=An(n,t);return this.cache.flow=o,o}finally{delete this.cache._flow}}parentFlowAbsolute(e){let t,n=this.group;for(;n;){const c=n.rawAttribute("flow");if(c!==void 0&&c.trim()!==""){t=c;break}n=n.parent}if(t===void 0&&(t=this.graph?.graphAttributes.flow),t===void 0||t.trim()==="")return e;const o=t.trim().toLowerCase();if(o==="inherit")return e;const s=$n[o];if(s!==void 0)return s;const r=ae[o];if(r!==void 0)return r;throw new Error(`Invalid parent flow: ${t}`)}shuffleDir(e,t){const n=t??90;if(n===90)return[...e];let o=[0,1,2,3];return n===180&&(o=[1,2,0,3]),n===270&&(o=[2,3,1,0]),n===0&&(o=[3,0,2,1]),[e[o[0]],e[o[1]],e[o[2]],e[o[3]]]}shift(e){let t=this.flow();return t+=e,t<0&&(t+=360),t>360&&(t-=360),t}calcSize(){const e={cx:!0,cy:!0},t=this.rawAttribute("rows"),n=this.rawAttribute("columns");t!==void 0&&n===void 0&&delete e.cy,n!==void 0&&t===void 0&&delete e.cx;const o=s=>{const r=s.trim();if(r==="")return 1;const c=Number(r);if(!Number.isFinite(c))throw new Error(`Invalid node dimension: '${s}'`);const f=Math.abs(c);return f===0?1:f};return this.cy=o(this.attribute("rows")||"1"),this.cx=o(this.attribute("columns")||"1"),e}grow(){const e=["north","south","east","west"],t={north:new Set,south:new Set,east:new Set,west:new Set},n={north:0,south:0,east:0,west:0},o={north:0,south:0,east:0,west:0},s={north:0,south:0,east:0,west:0};let r=0,c=0;const f=this.edges();for(const m of f){m.from===this&&c++;for(const x of[0,1]){const b=x===0?"start":"end";if((x===0?m.from:m.to)!==this)continue;const[v,S]=m.port(b);if(v!==void 0)if(S===void 0||Number.isNaN(S))n[v]+=1;else{let E=S;Math.abs(E)>9999&&(E=9999),t[v].has(E)||(o[v]+=1,t[v].add(E));let $=E;$<0&&($=Math.abs($)-1),$+=1,$>s[v]&&(s[v]=$)}else r+=1}}for(const m of f)m.to===m.from&&(r-=1);if(r<4&&r===f.length){this.calcSize();return}const l={north:0,south:0,east:0,west:0},h={north:0,south:0,east:0,west:0};for(const m of e)h[m]=s[m]-o[m],l[m]=s[m],h[m]<2*n[m]&&(l[m]+=2*n[m]-h[m]-1);const u=Math.max(l.north,l.south),a=Math.max(l.west,l.east),w=this.calcSize();this.cx=Math.max(this.cx??1,u),this.cy=Math.max(this.cy??1,a);const p=this.flow();let y="east";p===270?y="west":p===180?y="south":p===0&&(y="north");let g=0,d=Object.keys(w).sort();for(d.length>1&&(p===90||p===270)&&(d=["cy","cx"]),(this.origin!==void 0||this.children.size>0)&&(c=1);;){let m=0;for(const b of["north","south"])c===0&&y===b||(m+=1+Math.floor(((this.cx??1)-n[b]-o[b])/2));for(const b of["east","west"])c===0&&y===b||(m+=1+Math.floor(((this.cy??1)-n[b]-o[b])/2));if(m>=r)break;const x=d[g];if(x==="cx")this.cx=(this.cx??1)+2;else if(x==="cy")this.cy=(this.cy??1)+2;else break;g+=1,g>=d.length&&(g=0)}}nearPlaces(e,t,n,o,s){if(this.x===void 0||this.y===void 0)throw new Error(`nearPlaces: node ${this.id} is not placed`);const r=this.cx??1,c=this.cy??1,f=t??2,l=n??[V,q,J,W],h=s??this.flow(),u=this.shuffleDir([0,3,6,9],h);if(r+c===2){const v=[this.x+f,this.y,l[0],this.x,this.y+f,l[1],this.x-f,this.y,l[2],this.x,this.y-f,l[3]],S=[];for(let E=0;E<4;E++){const $=u[E],N=v[$],A=v[$+1],L=v[$+2];!o&&e.has(`${N},${A}`)||(S.push(N,A),n&&S.push(L))}return S}const a=this.x,w=this.y,p=[[],[],[],[]],y=r-1,g=c-1;let d=0,m=l[d++],x=a+y+f;for(let v=0;v<=g;v++){const S=w+v;!o&&e.has(`${x},${S}`)||(p[0].push(x,S),n&&p[0].push(m))}let b=w+g+f;m=l[d++];for(let v=0;v<=y;v++)x=a+v,!(!o&&e.has(`${x},${b}`))&&(p[1].push(x,b),n&&p[1].push(m));x=a-f,m=l[d++];for(let v=0;v<=g;v++)b=w+v,!(!o&&e.has(`${x},${b}`))&&(p[2].push(x,b),n&&p[2].push(m));b=w-f,m=l[d];for(let v=0;v<=y;v++)x=a+v,!(!o&&e.has(`${x},${b}`))&&(p[3].push(x,b),n&&p[3].push(m));const k=[];for(let v=0;v<4;v++){const S=Math.floor(u[v]/3);k.push(...p[S])}return k}allowedPlaces(e,t,n=2){const o=[];let s=0;for(;s<e.length;){const r=e[s],c=e[s+1];let f=0,l=0;for(;l<t.length;){const h=t[l],u=t[l+1];if(h===r&&u===c){f++;break}l+=2}if(f)for(let h=0;h<n;h++)o.push(e[s+h]);s+=n}return o}allow(e,t){let n=e;typeof n=="string"&&/^(front|forward|back|left|right)$/.test(n)&&(n=this.flow());const s={south:[0,0,0,1,"cx",1,0],north:[0,-1,0,0,"cx",1,0],east:[0,0,1,0,"cy",0,1],west:[-1,0,0,0,"cy",0,1],180:[0,0,0,1,"cx",1,0],0:[0,-1,0,0,"cx",1,0],90:[0,0,1,0,"cy",0,1],270:[-1,0,0,0,"cy",0,1]}[String(n)];if(!s)return[];if(this.x===void 0||this.y===void 0)throw new Error(`allow: node ${this.id} is not placed`);const r=this.cx??1,c=this.cy??1;let f=s[0]+this.x+s[2]*r,l=s[1]+this.y+s[3]*c;const h=[],u=s[4]==="cx"?r:c;if(t===void 0)for(let a=0;a<u;a++)h.push(f,l),f+=s[5],l+=s[6];else{let a=t;a<0&&(a=u+a),a<0&&(a=0),a>=u&&(a=u-1),f+=s[5]*a,l+=s[6]*a,h.push(f,l)}return h}}class R{constructor(e,t,n,o,s,r){this.edge=e,this.x=t,this.y=n,this.type=o,e.addCell(this,s,r)}w;h;cx;cy;crossHorEdge;crossVerEdge;isEdgeCell(){return!0}get group(){return this.edge.group}makeCross(e,t){const n=this.type&B;if(n!==_&&n!==O)throw new Error(`Trying to cross non hor/ver piece at ${this.x},${this.y}`);n===_?(this.crossHorEdge=this.edge,this.crossVerEdge=e):(this.crossHorEdge=e,this.crossVerEdge=this.edge),this.type=rt+(t&ht)}makeJoint(e,t){if((this.type&B)>=ce)throw new Error(`Trying to join invalid edge piece at ${this.x},${this.y}`);this.type=t}}class ge{constructor(e,t){this.x=e,this.y=t}isNodeCell(){return!0}get group(){}}class ot{constructor(e,t,n){this.group=e,this.x=t,this.y=n,e._addCell(this)}w;h;cx;cy;cellClass=" gi";hasLabel=!1;label="";isGroupCell(){return!0}setType(e){const t=[[0,-1," gt"],[1,0," gr"],[0,1," gb"],[-1,0," gl"]],n=this.x,o=this.y;let s="";for(const[r,c,f]of t){const h=e.get(`${n+r},${o+c}`)?.group;h&&h===this.group||(s+=f)}s===" gt gr gb gl"&&(s=" ga"),this.cellClass=s}setLabel(){this.hasLabel=!0,this.label=this.group.label()}}class Wt{constructor(e,t,n){this.node=e,this.x=t,this.y=n}isNodeCell(){return!0}get group(){return this.node.group}}function At(i){const e=i.attribute("style").trim();return e===""?"solid":e}function Ke(i){const e=i.attribute("borderstyle").trim();return e!==""?e:i.name.trim()===""?"none":"dashed"}function dt(i){const e=i.attribute("shape").trim().toLowerCase();if(e==="none"||e==="invisible")return"none";const t=i.attribute("borderstyle").trim();return t===""?"solid":t}const Sn={dotteddashed:"dot-dash",dasheddotted:"dot-dash","double-dashdouble":"double","doubledouble-dash":"double",doublesolid:"double",soliddouble:"double","dotteddot-dash":"dot-dash","dot-dashdotted":"dot-dash"};function $e(i,e){const t=i===""?"none":i,n=e===""?"none":e;if(t===n||n==="none")return t;if(t==="none")return n;for(const s of["broad","wide","bold","double","solid"])if(t===s||n===s)return s;const o=`${t}${n}`;return Sn[o]??n}function Ct(i,e){const t=i===""?"none":i,n=e===""?"none":e;return t==="dashed"&&n==="double"?"dashed":$e(t,n)}function Rt(i,e,t){const n=i.get(`${e},${t}`);if(n){if(n instanceof $t)return n;if(n instanceof Wt)return n.node}}function Ze(i,e){const t=dt(i),n={left:t,top:t,right:t,bottom:t};if(i.x===void 0||i.y===void 0)return n;const o=i.x,s=i.y,r=Rt(e,o-1,s),c=Rt(e,o,s-1),f=Rt(e,o+1,s),l=Rt(e,o,s+1),h=u=>!u||u===i?!1:u.attribute("shape").trim().toLowerCase()!=="invisible";return h(r)&&dt(r)!=="none"&&(n.left="none"),h(c)&&dt(c)!=="none"&&(n.top="none"),h(f)&&(n.right=$e(dt(f),t)),h(l)&&(n.bottom=$e(dt(l),t)),n}function _t(i){if(i.undirected)return"none";const e=i.attribute("arrowstyle").trim();return e===""?"open":e}function Ot(i){return i.attribute("arrowshape").trim()}function xt(i){const e=i.attribute("textwrap").trim().toLowerCase();return e===""?"none":e}function bt(i,e){const t=i.attribute("align").trim().toLowerCase();return t===""?e:t}function Nn(i,e,t){let n=i.replace(/\\[nrlc]/g," ");n=n.replace(/\s+/g," ");let o=t;o==="auto"&&(o=String(Math.trunc(Math.sqrt(n.length)*1.4)));let s=Number(o);Number.isFinite(s)||(s=n.length),s<2&&(s=2);let r=0,c=0,f=0,l=0;const h=[];for(;r<n.length;){const p=n[r];if(p===" "&&(f=r),p==="-"&&(l=r),c+=1,c>=s&&(f!==0||l!==0)){let y=f,g="";l>f&&(y=l,g="-"),h.push(n.slice(0,y)+g),n=n.slice(y+1),c=0,r=0,f=0,l=0;continue}r+=1}n!==""&&h.push(n);const u=e.slice(0,1).toLowerCase(),a=u==="l"?"l":u==="r"?"r":"c",w=[];for(let p=0;p<=h.length;p++)w.push(a);return{lines:h,aligns:w}}function vt(i,e,t){const n=e===""?"center":e,o=t===""?"none":t;if(o!=="none")return Nn(i,n,o);const s=[],r=[],c=n.slice(0,1).toLowerCase(),f=c==="l"?"l":c==="r"?"r":"c";let l=f,h=i;for(;h!=="";){const u=/^(.*?)(?:\\([nrlc])|$)/s.exec(h);if(!u)break;let a=u[1];const w=u[2]??"n";h=h.slice(a.length+(u[2]?2:0)),a=a.replace(/\\\|/g,"|"),a=a.replace(/\\\\/g,"\\"),a=a.replace(/^\s+/,""),a=a.replace(/\s+$/,""),a=a.replace(/\s+/g," ");const p=w==="n"?f:w;s.push(a),r.push(l),l=p}return{lines:s,aligns:r}}function le(i){let e=0;for(const t of i)e=Math.max(e,t.length);return{w:e,h:i.length}}function Cn(i){if(i.w!==void 0&&i.h!==void 0)return;if(i.w=5,i.h=3,(i.type&qe)!==0){i.w=1,i.h=1;return}const e=i.type&wn,t=i.type&B;i.edge.bidirectional&&e!==0&&(t===_&&(i.w+=1),t===O&&(i.h+=1));const n=i.type&yn,o=i.type&mn;if(n&&(t===gt||t===wt)&&(i.w+=1),o&&(t===yt||t===mt)&&(i.h+=1),At(i.edge)==="dot-dot-dash"&&(i.w+=1),t>=gn&&(i.w=7,(t===Qt||t===Tt)&&(i.w=8),i.h=3,t!==Qt&&t!==Tt&&(i.h=5)),i.type===_)i.w=0;else if(i.type===O)i.h=0;else if((i.type&Y)!==0){const r=bt(i.edge,"left"),c=xt(i.edge),{lines:f}=vt(i.edge.labelText(),r,c);let{w:l,h}=le(f);h!==0&&(h-=1),i.h+=h,i.w+=l}}function Pn(i,e){if(i.w!==void 0&&i.h!==void 0)return;const t=i.attribute("shape").trim().toLowerCase();if(t==="edge"){const u=bt(i,"left"),a=xt(i),{lines:w}=vt(i.labelText(),u,a),p=w.some(x=>x!=="");let{w:y,h:g}=le(w);p||(y=0,g=0);const d=3,m=g===0?3:4;g!==0&&(g-=1),i.w=m+y,i.h=d+g;return}if(t==="point"){i.w=5,i.h=3;const u=i.attribute("pointstyle").trim().toLowerCase(),a=i.attribute("pointshape").trim().toLowerCase();if(u==="invisible"||a==="invisible"){i.w=0,i.h=0;return}return}if(t==="invisible"){i.w=3,i.h=3;return}const n=bt(i,"center"),o=xt(i),{lines:s}=vt(i.labelText(),n,o),r=le(s),c=dt(i),f=Ze(i,e);let l=r.w+2,h=r.h;c!=="none"?(f.left!=="none"&&(l+=1),f.right!=="none"&&(l+=1),f.top!=="none"&&(h+=1),f.bottom!=="none"&&(h+=1)):h+=2,i.w=l,i.h=h}function Ln(i){if(i.w!==void 0&&i.h!==void 0)return;const e=Ke(i.group);if(i.w=0,i.h=0,i.hasLabel&&(i.h=1),e!=="none"&&(i.hasLabel||/g[rltb]\s/.test(i.cellClass)?(i.w=2,i.h=2):/^ g[rl]$/.test(i.cellClass)?i.w=2:/^ g[bt]$/.test(i.cellClass)&&(i.h=2)),i.hasLabel){const t=bt(i.group,"left"),n=xt(i.group),{lines:o}=vt(i.label,t,n),s=le(o);i.h+=s.h,i.w+=s.w}}function _e(i,e){if(!(e<1)){if(i.length===1){i[0]<e&&(i[0]=e);return}for(;;){let t=0,n=0,o=e+1,s=0;for(const r of i)t+=r,r!==0&&(r<o&&(o=r,s=n),n+=1);if(t>=e)break;i[s]+=1}}}function Qe(i){return[...i.entries()].sort(([e],[t])=>e.localeCompare(t))}function me(i){return i instanceof $t||i instanceof R||i instanceof ot}function jt(i){return{cx:i.cx??1,cy:i.cy??1}}function Tn(i){const e=new Map,t=new Map;let n=-1e6,o=-1e6;const s=Qe(i);for(const[,a]of s){let w=0,p=0,y=0,g=0,d=1,m=1;if(a instanceof Wt||a instanceof ge)w=a.x,p=a.y;else if(a instanceof R)Cn(a),w=a.x??0,p=a.y??0,y=a.w??0,g=a.h??0,{cx:d,cy:m}=jt(a);else if(a instanceof ot)Ln(a),w=a.x??0,p=a.y??0,y=a.w??0,g=a.h??0,{cx:d,cy:m}=jt(a);else if(a instanceof $t)Pn(a,i),w=a.x??0,p=a.y??0,y=a.w??0,g=a.h??0,{cx:d,cy:m}=jt(a);else continue;d+m===2&&(e.set(p,Math.max(e.get(p)??0,g)),t.set(w,Math.max(t.get(w)??0,y))),n=Math.max(n,w),o=Math.max(o,p)}e.set(o+1,0),t.set(n+1,0);for(const[,a]of s){if(!me(a))continue;const{cx:w,cy:p}=jt(a);if(w+p<=2)continue;const y=a.x??0,g=a.y??0;{const d=[];for(let m=0;m<w;m++)d.push(t.get(m+y)??0);_e(d,a.w??0);for(let m=0;m<w;m++)t.set(m+y,d[m])}{const d=[];for(let m=0;m<p;m++)d.push(e.get(m+g)??0);_e(d,a.h??0);for(let m=0;m<p;m++)e.set(m+g,d[m])}}const r=new Map,c=new Map;let f=0;for(const a of[...e.keys()].sort((w,p)=>w-p)){const w=e.get(a)??0;r.set(a,f),f+=w}f=0;for(const a of[...t.keys()].sort((w,p)=>w-p)){const w=t.get(a)??0;c.set(a,f),f+=w}let l=0,h=0;const u=(a,w)=>{let p=w;for(;!a.has(p);)p+=1;return a.get(p)??0};for(const[,a]of s){if(!me(a))continue;const{cx:w,cy:p}=jt(a);if(w+p!==2)continue;const y=a.x??0,g=a.y??0,d=c.get(y)??0,m=r.get(g)??0;a.minw=a.w,a.minh=a.h;const x=u(c,y+1),b=u(r,g+1);a.w=x-d,a.h=b-m,l=Math.max(l,m+(a.h??0)-1),h=Math.max(h,d+(a.w??0)-1)}for(const[,a]of s){if(!me(a))continue;const{cx:w,cy:p}=jt(a);if(w+p<=2)continue;const y=a.x??0,g=a.y??0,d=c.get(y)??0,m=r.get(g)??0;a.minw=a.w,a.minh=a.h;const x=u(c,y+w),b=u(r,g+p);a.w=x-d,a.h=b-m,l=Math.max(l,m+(a.h??0)-1),h=Math.max(h,d+(a.w??0)-1)}return{rows:r,cols:c,maxX:h,maxY:l}}function _n(i,e){const t=[];for(let n=0;n<e;n++){const o=[];for(let s=0;s<i;s++)o.push(" ");t.push(o)}return t}function D(i,e,t,n){n!==""&&(t<0||t>=i.length||e<0||e>=i[t].length||n!==" "&&(i[t][e]=n))}function ft(i,e,t,n){for(let o=0;o<n.length;o++)D(i,e+o,t,n[o])}function Ut(i,e,t,n){for(let o=0;o<n.length;o++)D(i,e,t+o,n[o])}function Bt(i,e,t,n,o,s,r="middle"){const{lines:c,aligns:f}=s,l=Math.trunc(t),h=t-l;let u=t+o/2-c.length/2,a=0;r==="top"?u=t:r==="bottom"?u=l+(o-c.length):a=h;const w=n/2;for(let p=0;p<c.length;p++){const y=c[p],g=f[p]??"l";let d=0;g==="c"?d=w-y.length/2:g==="r"&&(d=n-y.length);const m=Math.trunc(e+d),x=Math.trunc(u+p+a);ft(i,m,x,y)}}const Oe={solid:["--","|","+","+","+","+","+"],double:["==","H","#","#","#","#","#"],"double-dash":["= ",'"',"#","#","#","#","#"],dotted:["..",":",":",".",".",".","."],dashed:["- ","'","+","+","+","+","+"],"dot-dash":[".-","!","+","+","+","+","+"],"dot-dot-dash":["..-","!","+","+","+","+","+"],wave:["~~","}","+","*","*","*","*"],bold:["##","#","#","#","#","#","#"],"bold-dash":["# ","#","#","#","#","#","#"],wide:["##","#","#","#","#","#","#"],broad:["##","#","#","#","#","#","#"],invisible:["  "," "," "," "," "," "," "]},On={boldsolid:"+",dashedsolid:"+",dottedsolid:"!",dottedwave:"+",doublesolid:"+","dot-dashsolid":"+","dot-dot-dashsolid":"+",soliddotted:"+",solidwave:"+",soliddashed:"+",soliddouble:"H",wavesolid:"+"},In={triangle:0,diamond:1,box:2,dot:3,inv:4,line:5,cross:6,x:7},Mn=[{open:[">","<","^","v"],closed:[">","<","^","v"],filled:[">","<","^","v"]},{open:[">","<","^","v"],closed:[">","<","^","v"],filled:[">","<","^","v"]},{open:["]","[","Â°","u"],closed:["D","D","D","D"],filled:["#","#","#","#"]},{open:[")","(","^","u"],closed:["o","o","o","o"],filled:["*","*","*","*"]},{open:["<",">","v","^"],closed:["<",">","v","^"],filled:["<",">","v","^"]},{open:["|","|","_","-"],closed:["|","|","_","-"],filled:["|","|","_","-"]},{open:["+","+","+","+"],closed:["+","+","+","+"],filled:["+","+","+","+"]},{open:["x","x","x","x"],closed:["x","x","x","x"],filled:["x","x","x","x"]}];function St(i){return Oe[i]??Oe.solid}function U(i,e,t){const n=In[t]??0,o=Mn[n][i];if(!o)throw new Error(`Unknown arrow style '${i}'`);return o[e]??o[0]}function Gn(i,e,t,n,o){const s=i.w??0,r=i.h??0;if(s<=0||r<=0)return;const c=St(At(i.edge)),f=c[0].length,l=Math.floor(2+s/f);let h=c[0].repeat(Math.max(0,l));const u=o%f,a=i.type&~Je;u!==0&&a!==xn&&a!==bn&&(h=h.slice(u)),h.length>s&&(h=h.slice(0,s));const w=i.type&ht,p=_t(i.edge),y=p!=="none"?Ot(i.edge):"";let g=0,d=1,m=0;if((w&X)!==0&&(g+=1,h=h.slice(0,Math.max(0,h.length-1)),d+=1),(w&Q)!==0&&(h=h.slice(0,Math.max(0,h.length-1))),(w&J)!==0&&(h=h.slice(0,Math.max(0,h.length-1)),p!=="none"&&h.length>0&&(h=h.slice(0,-1)+U(p,de,y)),m+=1),(w&V)!==0&&(p==="none"?h.length>0&&(h=" "+h.slice(1)):h.length>=2&&(h=" "+U(p,pe,y)+h.slice(2)),d+=1),ft(e,t+g,n+(r-2),h),(i.type&Y)!==0){const x=bt(i.edge,"left"),b=xt(i.edge),k=vt(i.edge.labelText(),x,b),v=0,S=d+m,E=2,$=s-S-d,N=r-E-v;Bt(e,t+d,n+v,$,N,k,"bottom")}}function Rn(i,e,t,n){const o=i.w??0,s=i.h??0;if(o<=0||s<=0)return;const r=St(At(i.edge)),c=r[1].length,f=Math.floor(1+s/c);let l=r[1].repeat(Math.max(0,f));l.length>s&&(l=l.slice(0,s));const h=i.type&ht,u=_t(i.edge);if(u!=="none"){const a=Ot(i.edge);(h&q)!==0&&l.length>0&&(l=U(u,Xt,a)+l.slice(1)),(h&W)!==0&&l.length>0&&(l=l.slice(0,-1)+U(u,Yt,a))}if(Ut(e,t+2,n+0,l),(i.type&Y)!==0){const a=bt(i.edge,"left"),w=xt(i.edge),p=vt(i.edge.labelText(),a,w),y=4,g=Math.max(0,o-y),d=s;Bt(e,t+y,n,g,d,p,"middle")}}function Dn(i,e,t,n,o){const s=i.w??0,r=i.h??0;if(s<=0||r<=0)return;const c=i.type&B,f=i.type&ht,l=i.crossHorEdge??i.edge,h=i.crossVerEdge??i.edge,u=At(l),a=At(h),w=St(u),p=St(a),y=`${u}${a}`,g=c===rt?On[y]??w[2]:w[2],d=_t(l),m=d!=="none"?Ot(l):"",x=_t(h),b=x!=="none"?Ot(h):"",k=r-2;{const v=p[1].length,S=Math.floor(2+r/v);let E=p[1].repeat(Math.max(0,S));E.length>r&&(E=E.slice(0,r)),x!=="none"&&((f&q)!==0&&E.length>0&&(E=U(x,Xt,b)+E.slice(1)),(f&W)!==0&&E.length>0&&(E=E.slice(0,-1)+U(x,Yt,b))),c===gt?E=" ".repeat(k)+E.slice(k):c===wt&&(E=E.slice(0,k)+"  "+E.slice(k+2)),Ut(e,t+2,n+0,E)}{const v=w[0].length,S=Math.floor(2+s/v);let E=w[0].repeat(Math.max(0,S));const $=o%v;$!==0&&(E=E.slice($)),E.length>s&&(E=E.slice(0,s));let N=0;(f&X)!==0&&(N+=1,E=E.slice(0,Math.max(0,E.length-1))),(f&Q)!==0&&(E=E.slice(0,Math.max(0,E.length-1))),(f&J)!==0&&(E=E.slice(0,Math.max(0,E.length-1)),d!=="none"&&E.length>0&&(E=E.slice(0,-1)+U(d,de,m))),(f&V)!==0&&(d==="none"?E.length>0&&(E=" "+E.slice(1)):E.length>=2&&(E=" "+U(d,pe,m)+E.slice(2))),c===yt?E="  "+E.slice(2):c===mt&&(E=E.slice(0,2)+" ".repeat(Math.max(0,s-2))),ft(e,t+N,n+k,E)}D(e,t+2,n+k,g)}function Bn(i,e,t,n,o){const s=i.w??0,r=i.h??0;if(s<=0||r<=0)return;const c=i.type&B,f=i.type&ht,l=St(At(i.edge));let h=1,u=r-1;(c===K||c===H)&&(h=r-2,u=0);{const a=l[1].length,w=Math.floor(1+h/a);let p=l[1].repeat(Math.max(0,w));p.length>h&&(p=p.slice(0,h));const y=_t(i.edge);if(y!=="none"){const g=Ot(i.edge);(f&q)!==0&&p.length>0&&(p=U(y,Xt,g)+p.slice(1)),(f&W)!==0&&p.length>0&&(p=p.slice(0,-1)+U(y,Yt,g))}Ut(e,t+2,n+u,p)}{let a=s-3,w=r-2,p=3;(c===H||c===Z)&&(a=2,p=0);const y=l[0].length,g=Math.floor(2+a/y);let d=l[0].repeat(Math.max(0,g));const m=(p+o)%y;m!==0&&(d=d.slice(m)),d.length>a&&(d=d.slice(0,a)),(f&Q)!==0&&d.length>0&&(d=d.slice(0,-1)+" "),(f&X)!==0&&d.length>0&&(d=" "+d.slice(1));const x=_t(i.edge),b=x!=="none"?Ot(i.edge):"";(f&J)!==0&&(x==="none"?d.length>0&&(d=d.slice(0,-1)+" "):d.length>=2&&(d=d.slice(0,-2)+U(x,de,b)+" ")),(f&V)!==0&&(x==="none"?d.length>0&&(d=" "+d.slice(1)):d.length>=2&&(d=" "+U(x,pe,b)+d.slice(2))),ft(e,t+p,n+w,d);let k=3;c===Z?k=4:c===K?k=5:c===H&&(k=6),D(e,t+2,n+w,l[k])}}function Xe(i,e,t,n,o,s,r,c,f){const l=i.w??0,h=i.h??0;if(l<=0||h<=0)return;const u=bt(i.edge,"left"),a=xt(i.edge),w=vt(i.edge.labelText(),u,a);let p=s;const y=l-r-o,g=h-c-p;Bt(e,t+o,n+p,y,g,w,f)}function Wn(i,e,t,n,o){const s=i.w??0,r=i.h??0;if(s<=0||r<=0)return;const c=i.type&B,f=i.type&ht,l=St(At(i.edge));let h=1,u=r-1;c===Tt&&(h=r-2,u=0);const a=l[1].length,w=Math.floor(1+h/a);let p=l[1].repeat(Math.max(0,w));p.length>h&&(p=p.slice(0,h));const y=_t(i.edge),g=y!=="none"?Ot(i.edge):"";{let N=p;i.edge.bidirectional&&y!=="none"&&((f&q)!==0&&N.length>0&&(N=U(y,Xt,g)+N.slice(1)),(f&W)!==0&&N.length>0&&(N=N.slice(0,-1)+U(y,Yt,g))),Ut(e,t+(s-3),n+u,N)}{let N=p;y!=="none"&&((f&q)!==0&&N.length>0&&(N=U(y,Xt,g)+N.slice(1)),(f&W)!==0&&N.length>0&&(N=N.slice(0,-1)+U(y,Yt,g))),Ut(e,t+2,n+u,N)}const d=s-6,m=r-2,x=3,b=l[0].length,k=Math.floor(2+d/b);let v=l[0].repeat(Math.max(0,k));const S=(x+o)%b;S!==0&&(v=v.slice(S)),v.length>d&&(v=v.slice(0,d)),ft(e,t+x,n+m,v);let E=3;c===Tt&&(E=5),D(e,t+2,n+m,l[E]),D(e,t+(s-3),n+m,l[E+1]);const $=c===Tt?"top":"bottom";(i.type&Y)!==0&&Xe(i,e,t,n,4,0,4,2,$)}function jn(i,e,t,n,o){const s=i.w??0,r=i.h??0;if(s<=0||r<=0)return;const c=i.type&B,f=i.type&ht,l=St(At(i.edge));{const S=l[1].length,E=Math.floor(1+1/S);let $=l[1].repeat(Math.max(0,E));$.length>1&&($=$.slice(0,1));const N=c===Lt?s-3:2,A=r-3;Ut(e,t+N,n+A,$)}const h=s-3,u=r-4,a=r-2,w=c===Lt?1:2,p=l[0].length,y=Math.floor(2+h/p);let g=l[0].repeat(Math.max(0,y));const d=(w+o)%p;d!==0&&(g=g.slice(d)),g.length>h&&(g=g.slice(0,h));const m=_t(i.edge),x=m!=="none"?Ot(i.edge):"",b=S=>{if(m==="none")return S;let E=S;return(f&V)!==0&&E.length>0&&(E=U(m,pe,x)+E.slice(1)),(f&J)!==0&&E.length>0&&(E=E.slice(0,-1)+U(m,de,x)),E};{const S=i.edge.bidirectional?b(g):g;ft(e,t+w,n+u,S)}{const S=b(g);ft(e,t+w,n+a,S)}const k=c===Lt?s-3:2;let v=3;if(c===Lt&&(v=4),D(e,t+k,n+u,l[v]),D(e,t+k,n+a,l[v+2]),(i.type&Y)!==0){const S=c===Lt?3:4;Xe(i,e,t,n,S,0,S,4,"bottom")}}function Fn(i,e,t,n){const o=i.type&B;if(At(i.edge)==="invisible"&&o!==rt)return;const s=t;if(o===_)return Gn(i,e,t,n,s);if(o===O)return Rn(i,e,t,n);if(o===nt||o===Z||o===K||o===H)return Bn(i,e,t,n,s);if(o===rt||o===mt||o===yt||o===wt||o===gt)return Dn(i,e,t,n,s);if(o===Qt||o===Tt)return Wn(i,e,t,n,s);if(o===Lt||o===Ne)return jn(i,e,t,n,s);throw new Error(`Unknown edge cell type ${o} at ${i.x},${i.y}`)}const zn={solid:{ul:"+",ur:"+",lr:"+",ll:"+",horTop:"-",horBottom:"-",verLeft:["|"],verRight:["|"]},dotted:{ul:".",ur:".",lr:":",ll:":",horTop:".",horBottom:".",verLeft:[":"],verRight:[":"]},dashed:{ul:"+",ur:"+",lr:"+",ll:"+",horTop:"- ",horBottom:"- ",verLeft:["'"],verRight:["'"]},"dot-dash":{ul:"+",ur:"+",lr:"+",ll:"+",horTop:".-",horBottom:".-",verLeft:["!"],verRight:["!"]},"dot-dot-dash":{ul:"+",ur:"+",lr:"+",ll:"+",horTop:"..-",horBottom:"..-",verLeft:["|",":"],verRight:["|",":"]},bold:{ul:"#",ur:"#",lr:"#",ll:"#",horTop:"#",horBottom:"#",verLeft:["#"],verRight:["#"]},"bold-dash":{ul:"#",ur:"#",lr:"#",ll:"#",horTop:"# ",horBottom:"# ",verLeft:["#"," "],verRight:["#"," "]},double:{ul:"#",ur:"#",lr:"#",ll:"#",horTop:"=",horBottom:"=",verLeft:["H"],verRight:["H"]},"double-dash":{ul:"#",ur:"#",lr:"#",ll:"#",horTop:"= ",horBottom:"= ",verLeft:['"'],verRight:['"']},wave:{ul:"+",ur:"+",lr:"+",ll:"+",horTop:"~",horBottom:"~",verLeft:["{","}"],verRight:["{","}"]},broad:{ul:"#",ur:"#",lr:"#",ll:"#",horTop:"#",horBottom:"#",verLeft:["#"],verRight:["#"]},wide:{ul:"#",ur:"#",lr:"#",ll:"#",horTop:"#",horBottom:"#",verLeft:["#"],verRight:["#"]},none:{ul:" ",ur:" ",lr:" ",ll:" ",horTop:" ",horBottom:" ",verLeft:[" "],verRight:[" "]}};function st(i){const e=zn[i];if(!e)throw new Error(`Unknown node border style '${i}'`);return e}function Un(i,e,t,n,o){const s=i.w??0,r=i.h??0;if(s<=0||r<=0)return;const c=i.attribute("shape").trim().toLowerCase();if(c==="invisible")return;if(c==="edge"){const E=St("solid"),$=E[0].length,N=Math.floor(2+s/$);let A=E[0].repeat(Math.max(0,N));const L=n%$;L!==0&&(A=A.slice(L)),A.length>s&&(A=A.slice(0,s)),ft(t,n,o+(r-2),A);const C=bt(i,"left"),P=xt(i),M=vt(i.labelText(),C,P),G=1,T=0,I=G,tt=2,ut=s-I-G,j=r-tt-T;Bt(t,n+G,o+T,ut,j,M,"bottom");return}const f=c==="rounded",l=dt(i),h=Ze(i,e),u=h.top,a=h.bottom,w=h.left,p=h.right,y=u!=="none",g=a!=="none",d=w!=="none",m=p!=="none",x=(()=>{if(i.x===void 0||i.y===void 0)return!1;const E=Rt(e,i.x-1,i.y);return!E||E.attribute("shape").trim().toLowerCase()==="invisible"?!1:dt(E)==="none"})(),b=l!=="none"&&x?n-1:n;if(l!=="none"){const E=(A,L,C,P)=>{const M=L.length,G=Math.floor(s/M)+2;let T=L.repeat(Math.max(0,G));T.length>s&&(T=T.slice(0,s)),C&&T.length>0&&(T=C+T.slice(1)),P&&s>0&&(T=T.slice(0,s-1)+P),ft(t,b,o+A,T)};if(y){const A=st(u),L=y&&d?Ct(u,w):"none",C=y&&m?Ct(u,p):"none";let P=L!=="none"?st(L).ul:void 0,M=C!=="none"?st(C).ur:void 0;f&&(P!==void 0&&(P=" "),M!==void 0&&(M=" ")),E(0,A.horTop,P,M)}if(g){const A=st(a),L=g&&d?Ct(a,w):"none",C=g&&m?Ct(a,p):"none";let P=L!=="none"?st(L).ll:void 0,M=C!=="none"?st(C).lr:void 0;if(f&&(P!==void 0&&(P=" "),M!==void 0&&(M=" ")),x&&d){const G=A.horBottom.length,T=Math.floor(s/G)+2;let I=A.horBottom.repeat(Math.max(0,T));I.length>s&&(I=I.slice(0,s)),P&&I.length>0&&(I=P+I.slice(1)),M&&s>0&&(I=I.slice(0,s-1)+M),I.length>1&&ft(t,b+1,o+r-1,I.slice(1))}else E(r-1,A.horBottom,P,M)}const $=y?1:0,N=g?r-2:r-1;if(d&&$<=N){const A=st(w);let L=0;for(let C=$;C<=N;C++){const P=A.verLeft[L%A.verLeft.length]??" ";L+=1,D(t,b,o+C,P)}}if(m&&$<=N){const A=st(p);let L=0;for(let C=$;C<=N;C++){const P=A.verRight[L%A.verRight.length]??" ";L+=1,D(t,b+s-1,o+C,P)}}if(!f){if(y&&d){const A=st(Ct(u,w));if(x){const L=st(w);D(t,b,o,L.verLeft[0]??" ")}else D(t,b,o,A.ul)}if(y&&m){const A=st(Ct(u,p));D(t,b+s-1,o,A.ur)}if(g&&d){const A=st(Ct(a,w));x?D(t,b,o+r-1," "):D(t,b,o+r-1,A.ll)}if(g&&m){const A=st(Ct(a,p));D(t,b+s-1,o+r-1,A.lr)}}}const k=bt(i,"center"),v=xt(i),S=vt(i.labelText(),k,v);if(l==="none"){let E=1,$=1;if(i.x!==void 0&&i.y!==void 0){const P=Rt(e,i.x-1,i.y),M=Rt(e,i.x+1,i.y);P&&dt(P)!=="none"&&(E=0),M&&dt(M)!=="none"&&($=0)}const N=E,A=0,L=s-E-$,C=r;Bt(t,b+N,o+A,L,C,S,"middle")}else{const N=s-4,A=r-2;Bt(t,b+2,o+.5,N,A,S,"middle")}}function Hn(i,e,t,n){const o=i.w??0,s=i.h??0;if(o<=0||s<=0)return;const r=Ke(i.group);if(r!=="none"){const c=i.cellClass,f=c.includes("ga"),l=f||c.includes("gt"),h=f||c.includes("gb"),u=f||c.includes("gl"),a=f||c.includes("gr"),w=St(r),p=w[0],y=w[1],g=w[2],d=m=>{const x=p.length,b=Math.floor(2+o/x);let k=p.repeat(Math.max(0,b));const v=t%x;v!==0&&(k=k.slice(v)),k.length>o&&(k=k.slice(0,o)),ft(e,t,n+m,k)};if(l&&d(0),h&&d(s-1),u)for(let m=0;m<s;m++)D(e,t,n+m,y);if(a)for(let m=0;m<s;m++)D(e,t+o-1,n+m,y);l&&u&&D(e,t,n,g),l&&a&&D(e,t+o-1,n,g),h&&u&&D(e,t,n+s-1,g),h&&a&&D(e,t+o-1,n+s-1,g)}if(i.hasLabel){const c=bt(i.group,"left"),f=xt(i.group),l=vt(i.label,c,f);let h=0,u=s;r!=="none"&&(h=.5,u=s-1),Bt(e,t,n+h,o,u,l,"middle")}}function Vn(i){i.cells||i.layout();const e=i.cells;if(!e)throw new Error("renderAscii(): graph.layout() did not produce cells");if(![...e.values()].some(g=>g instanceof $t||g instanceof R||g instanceof ot))return`
`;const{rows:n,cols:o,maxX:s,maxY:r}=Tn(e),c=_n(s+1,r+1),f=Qe(e);for(const[,g]of f){if(!(g instanceof ot))continue;const d=o.get(g.x??0)??0,m=n.get(g.y??0)??0;Hn(g,c,d,m)}for(const[,g]of f){if(!(g instanceof R))continue;const d=o.get(g.x??0)??0,m=n.get(g.y??0)??0;Fn(g,c,d,m)}for(const[,g]of f){if(!(g instanceof $t))continue;const d=o.get(g.x??0)??0,m=n.get(g.y??0)??0;Un(g,e,c,d,m)}const l=c.map(g=>g.join("").replace(/\s+$/g,""));for(;l.length>0&&l[l.length-1]==="";)l.pop();const h=l.join(`
`)+`
`,u=i.graphAttributes.label?.trim()??"";if(u==="")return h;const a=h.replace(/\n$/,"").split(`
`),p=Math.max(0,Math.trunc((s-u.length)/2));return[""," ".repeat(p)+u,"",...a].join(`
`)+`
`}function Ye(i){const e=i.x,t=i.y;if(!(typeof e!="number"||typeof t!="number"))return{x:e,y:t}}function qn(i,e){for(const t of i.nodes()){const n=t.cx??1,o=t.cy??1;t.cx=n*2-1,t.cy=o*2-1}for(const t of i.nodes()){if(t.x===void 0||t.y===void 0)continue;const n=t.cx??1,o=t.cy??1;for(let s=0;s<n;s++)for(let r=0;r<o;r++){if(s===0&&r===0)continue;const c=t.x+s,f=t.y+r,l=`${c},${f}`;e.has(l)||e.set(l,new Wt(t,c,f))}}}function Jn(i){const e=[...i.values()].filter(t=>t instanceof R).sort((t,n)=>t.x-n.x||t.y-n.y);for(const t of e){const n=t.edge;t.type&B;{const o=t.x+2,s=t.y,r=i.get(`${o},${s}`);if(r instanceof R&&(n===r.edge||r.type===rt||t.type===rt)){const c=`${t.x+1},${s}`;if(!i.has(c)){const f=r.edge===n?r:void 0;i.set(c,new R(n,t.x+1,s,_,t,f))}}}{const o=t.x,s=t.y+2,r=i.get(`${o},${s}`);if(r instanceof R&&(n===r.edge||r.type===rt||t.type===rt)){const c=`${o},${t.y+1}`;if(!i.has(c)){const f=r.edge===n?r:void 0;i.set(c,new R(n,o,t.y+1,O,t,f))}}}}}function Kn(i){const e=[...i.values()];for(const t of e){const n=t.group;if(!n)continue;const o=Ye(t);if(!o)continue;let s=o.x,r=o.y;const c=[-1,0,0,-1,1,0,1,0,0,1,0,1,-1,0,-1,0];for(let f=0;f<c.length;f+=2){s+=c[f],r+=c[f+1];const l=`${s},${r}`;i.has(l)||i.set(l,new ot(n,s,r))}}}function Zn(i){const e=[...i.values()];for(const t of e){if(!(t instanceof ot))continue;const n=t.x,o=t.y,s=t.group;{const r=`${n},${o+2}`,c=`${n},${o+1}`;if(i.has(r)&&!i.has(c)){const f=i.get(r);f instanceof ot&&f.group===s&&i.set(c,new ot(s,n,o+1))}}{const r=`${n+2},${o}`,c=`${n+1},${o}`;if(i.has(r)&&!i.has(c)){const f=i.get(r);f instanceof ot&&f.group===s&&i.set(c,new ot(s,n+1,o))}}}}function Qn(i){const e=new Map,t=new Map;for(const n of i.values()){const o=Ye(n);if(!o)continue;let s=e.get(o.y);s||(s=new Map,e.set(o.y,s)),s.set(o.x,n);let r=t.get(o.x);r||(r=new Map,t.set(o.x,r)),r.set(o.y,n)}return{rows:e,cols:t}}function tn(i,e,t,n,o,s,r,c){let f=s;e&&(f+=qe);const l=new R(t,n,o,f,r,c);e&&e._delCellAt(n,o),i.set(`${n},${o}`,l)}function Pt(i,e,t,n,o,s,r,c){if(!c||![...c.values()].some(u=>u instanceof ot&&r.test(u.cellClass)))return;e.type&=~o;const l=e.edge;let h;if((o&Gt)!==0){const u=l.cells.findIndex(a=>a===e);h=u===-1?void 0:u}else h=e;tn(i,l.group,l,t,n,s+o,h)}function Xn(i,e,t,n,o){const s=e.type;{const r=e.y;if((s&Gt)===X){const c=e.x-1;Pt(i,e,c,r,X,_,/g[rl]/,n.get(c))}if((s&Gt)===Q){const c=e.x+1;Pt(i,e,c,r,Q,_,/g[rl]/,n.get(c))}if((s&Ft)===J){const c=e.x+1;Pt(i,e,c,r,J,_,/g[rl]/,n.get(c))}if((s&Ft)===V){const c=e.x-1;Pt(i,e,c,r,V,_,/g[rl]/,n.get(c))}}{const r=e.x;if((s&Gt)===lt){const c=e.y-1;Pt(i,e,r,c,lt,O,/g[tb]/,t.get(c))}if((s&Gt)===at){const c=e.y+1;Pt(i,e,r,c,at,O,/g[tb]/,t.get(c))}if((s&Ft)===W){const c=e.y+1;Pt(i,e,r,c,W,O,/g[tb]/,t.get(c))}if((s&Ft)===q){const c=e.y-1;Pt(i,e,r,c,q,O,/g[tb]/,t.get(c))}}}function Yn(i,e,t){const n=e.x,o=e.y+1,s=`${n},${o}`;if(i.has(s)||(e.type&Ft)!==W)return;const r=t.get(o);!r||![...r.values()].some(f=>f instanceof ot&&/g[tb]/.test(f.cellClass))||(e.type&=~W,tn(i,void 0,e.edge,n,o,O+W,e))}function to(i){const{rows:e,cols:t}=Qn(i),n=[...i.values()].filter(o=>o instanceof R).sort((o,s)=>o.x-s.x||o.y-s.y);for(const o of n){if((o.x&1)!==0||(o.y&1)!==0)continue;o.group?Xn(i,o,e,t):Yn(i,o,e)}}function eo(i,e){if(i.groups.length===0)return e;for(const o of i.groups)o._clearCells();const t=new Map,n=[...e.entries()].sort(([o],[s])=>o.localeCompare(s));for(const[o,s]of n){const[r,c]=o.split(","),f=Number(r)*2,l=Number(c)*2;s.x=f,s.y=l,t.set(`${f},${l}`,s)}Jn(t),qn(i,t),Kn(t),Zn(t);for(const o of i.groups)o._setCellTypes(t);to(t);for(const o of i.groups)o._findLabelCell();return t}function pt(i){return i===0?0:i<0?-1:1}const no={"0,1,-1,0":H,"0,1,0,1":O,"0,1,1,0":K,"-1,0,0,-1":K,"-1,0,-1,0":_,"-1,0,0,1":nt,"0,-1,-1,0":Z,"0,-1,0,-1":O,"0,-1,1,0":nt,"1,0,0,-1":H,"1,0,1,0":_,"1,0,0,1":Z,"0,-1,0,1":Qt,"0,1,0,-1":Tt,"1,0,-1,0":Lt,"-1,0,1,0":Ne};function Ae(i,e,t,n,o,s){let r=pt(t-i),c=pt(n-e),f=pt(o-t),l=pt(s-n);f===0&&l===0&&(f=r,l=c),r===0&&c===0&&(r=f,c=l);const h=`${r},${c},${f},${l}`;return no[h]??_}const oo=new Map([[_,[X,Q,0,0,J,V,0,0]],[O,[0,0,lt,at,0,0,W,q]],[K,[0,Q,lt,0,J,0,0,q]],[H,[X,0,lt,0,0,V,0,q]],[nt,[0,Q,0,at,J,0,W,0]],[Z,[X,0,0,at,0,V,W,0]]]),so=new Map([[X,V],[Q,J],[at,W],[lt,q]]);function ie(i,e,t,n){if(i.undirected)return e;if(e.length<3||e.length%3!==0)throw new Error(`applyEndPoints: invalid coords length ${e.length}`);let o=0,s=2;for(const r of[t,n,t,n]){if(r!==0){const c=e[s]&B,f=oo.get(c);if(!f)throw new Error(`applyEndPoints: unsupported edge cell type ${c}`);const h=(r===-1?1:0)+o,u=f[h];if(u===void 0)throw new Error(`applyEndPoints: start-points index out of range (idx=${h})`);let a=u;i.bidirectional&&(a=so.get(a)??a),e[s]+=a}o+=2,o===4&&(s=e.length-1)}return e}class io{heap=[];add(e){if(this.heap.length===0){this.heap.push(e);return}if(e[0]<this.heap[0][0]){this.heap.unshift(e);return}if(e[0]>this.heap[this.heap.length-1][0]){this.heap.push(e);return}if(this.heap.length<10){for(let o=0;o<this.heap.length;o++)if(this.heap[o][0]>e[0]){this.heap.splice(o,0,e);return}this.heap.push(e);return}let t=0,n=this.heap.length;for(;n-t>2;){const o=Math.floor((n-t)/2+t);this.heap[o][0]<=e[0]?t=o:n=o}for(;t<this.heap.length;){if(this.heap[t][0]>e[0]){this.heap.splice(t,0,e);return}t++}this.heap.push(e)}elements(){return this.heap.length}extractTop(){return this.heap.shift()}deleteByXY(e,t){for(let n=0;n<this.heap.length;n++){const o=this.heap[n],s=o[1],r=o[2];if(s===e&&r===t){this.heap.splice(n,1);return}}}}const Zt=0,zt=1,fe=2,Ie=4;class ro{constructor(e,t,n){this.id=e,this.start=t,this.graph=n,this.end=t,t.chain=this,t.chainNext=void 0}end;len=1;done=!1;addNode(e){this.end.chainNext=e,this.end=e,e.chain=this,e.chainNext=void 0,this.len++}length(e){if(!e)return this.len;let t=e,n=0;for(;t;)n++,t=t.chainNext;return n}nodes(){const e=[];let t=this.start;for(;t;)e.push(t),t=t.chainNext;return e}layout(e){if(this.done)return[];this.done=!0;const t=e,n=[],o=this.graph;let s=this.start,r=s.chainNext;for(s.todo&&(t&&t.to===s&&(t.attribute("flow")!==""||t.hasPorts())?n.push(o._layoutAction(fe,s,0,t.from,t)):n.push(o._layoutAction(Zt,s,0,t)));r;){if(r.todo){const c=o.edgesBetween(s,r);n.push(o._layoutAction(fe,r,0,s,c[0]))}s=r,r=r.chainNext}for(s=this.start,r=s.chainNext;r;){for(const c of s.edges())c.to===r&&c.todo&&(n.push([zt,c]),c.todo=!1);s=r,r=r.chainNext}for(r=this.start;r;){const c=[];for(const f of r.edges()){if(f.from!==r||f.to===r||!f.todo||!f.to.chain||f.to.chain!==this||f.hasPorts())continue;let l=0,h=r;for(;h&&h!==f.to;)h=h.chainNext,l++;if(!h){for(h=f.to,l=0;h&&h!==f.from;)h=h.chainNext,l++;h||(l=1e5)}c.push([l,f])}c.sort((f,l)=>f[0]-l[0]);for(const[,f]of c)n.push([zt,f]),f.todo=!1;r=r.chainNext}for(r=this.start;r;){for(const c of r.edges())c.todo&&(c.from!==r||c.to!==r||(n.push([zt,c]),c.todo=!1));r=r.chainNext}for(r=this.start;r;){const c=r.edges().slice().map((f,l)=>({e:f,idx:l})).sort((f,l)=>{const h=f.e.to.id,u=l.e.to.id;return(h<u?-1:h>u?1:0)||f.idx-l.idx}).map(({e:f})=>f);for(const f of c){const h=f.to.chain;h&&(h.done||(n.push(...h.layout(f)),f.todo&&(n.push([zt,f]),f.todo=!1)))}r=r.chainNext}return n}merge(e,t){const n=e;if(this===n)return;let o=t;o&&o.chain!==n&&(o=void 0),o||(o=n.start);let s=this.start;for(;s;)s.chain=this,s=s.chainNext;for(this.end.chainNext=o,this.end=n.end,s=o;s;){s.chain=this;const r=s;if(s=s.chainNext,s&&s.chain===this){r.chainNext=void 0,this.end=r;break}}for(this.len=0,s=this.start;s;)this.len++,s=s.chainNext;o===n.start&&(n.len=0,n.done=!0)}}function it(i,e){return i<e?-1:i>e?1:0}function Dt(){return globalThis.process?.env?.GE_DEBUG_RUN_ID??"r1"}function ee(i,e){const t=Math.abs(e[0]);let n=0;for(;n<i.length&&Math.abs(i[n][0])<=t;)n++;i.splice(n,0,e)}function en(i){const e=i.graphAttributes.root;return e?e.trim():void 0}function co(i,e){const t=[],n=[],o=[...i.nodes()].sort((s,r)=>it(String(s.numericId),String(r.numericId)));e&&(e.rank=-1,ee(t,[-1,e]));for(const s of o){if(e&&s===e)continue;const r=s.rawAttribute("rank");let c;if(r!==void 0){const f=r.trim();if(f==="auto")c=void 0;else if(f==="same")c=0;else if(f!==""){const l=Number(f);if(!Number.isFinite(l))throw new Error(`Invalid node rank: ${r}`);c=l}}c!==void 0&&(c+=1),s.rank=c,s.rank===void 0&&s.predecessors().length===0&&(s.rank=-1),s.rank!==void 0?ee(t,[s.rank,s]):n.push(s)}for(;n.length!==0||t.length!==0;){for(;t.length!==0;){const[s,r]=t.shift();let c=r.rank??s;c>0&&(c=-c),c-=1;for(const f of r.successors())f.rank===void 0&&(f.rank=c,ee(t,[c,f]))}if(n.length===0)break;for(;n.length;){const s=n.shift();if(!s)break;if(s.rank===void 0){s.rank=-1,ee(t,[-1,s]);break}}}}function nn(i,e,t,n,o,s){const r=new ro(t.value++,o,i);e.set(r.id,r);let c=1;const f=[],l=u=>{s.has(u)||(s.add(u),f.push(u))};let h=o;for(;;){l(h);const u=new Map;for(const g of h.edges()){if(g.from===g.to)continue;let d=g.to;if(g.bidirectional&&d===h&&(d=g.from),d!==h){if(g.edgeFlow()!==void 0){u.clear(),u.set(d.id,d);break}s.has(d)||d.chain&&d.chain===r||d.findGrandparent()!==h.findGrandparent()&&(u.has(d.id)||u.set(d.id,d))}}if(u.size===0)break;if(u.size===1){const g=u.values().next().value;if(!g.chain){r.addNode(g),h=g,c++;continue}}let a=-1,w,p;const y=[...u.entries()].sort(([g],[d])=>it(g,d)).map(([,g])=>g);for(const g of y){g.chain||(c+=nn(i,e,t,n,g,s));const d=g.chain;!d||d===r||d.len>a&&(a=d.len,w=d,p=g)}w&&p&&(!n||p!==n)&&(r.merge(w,p),w.len===0&&e.delete(w.id));break}for(const u of f)s.delete(u);return c}function ao(i){for(const u of i.nodes())u.chain=void 0,u.chainNext=void 0;const e=[...i.nodes()].sort((u,a)=>it(String(u.numericId),String(a.numericId))),t=en(i),n=[];for(const u of e)n.push({name:u.id,hasPredecessors:u.hasPredecessors(),hasOrigin:u.origin&&u.origin!==u?1:0,absRank:Math.abs(u.rank??0)});const o=n.slice().sort((u,a)=>u.absRank-a.absRank||u.hasOrigin-a.hasOrigin||u.hasPredecessors-a.hasPredecessors||it(u.name,a.name)).map(u=>u.name),s=[t,...o],r=new Map,c={value:1};let f,l=0;const h=e.length;for(const u of s){if(!u)continue;const a=i.node(u);if(a){if(f||(f=a),l===h)break;a.chain||(l+=nn(i,r,c,f,a,new Set))}}return{root:f,chains:r}}function on(i){return i===0||i===180?"x":"y"}function It(i,e,t,n,o,s){const r=(c,f,l)=>{const h=c.cx??1,u=c.cy??1;for(let a=0;a<h;a++)for(let w=0;w<u;w++)if(i.has(`${f+a},${l+w}`))return!1;c.x=f,c.y=l,i.set(`${f},${l}`,c);for(let a=0;a<h;a++)for(let w=0;w<u;w++)a===0&&w===0||i.set(`${f+a},${l+w}`,new Wt(c,f+a,l+w));if(o&&s!==void 0){const a=Math.abs(c.rank??0),w=on(s);o.has(a)||o.set(a,w==="x"?f:l)}return!0};if(e.origin&&e.origin!==e||e.children.size>0){const[c,f,l]=e.findGrandparentWithOffset(),h=t+f,u=n+l,a=[],w=new Set,p=(d,m,x)=>{if(w.has(d))throw new Error(`Detected loop in children graph starting at '${c.id}'`);w.add(d),a.push([d,m,x]);const b=[...d.children.values()].sort((k,v)=>it(k.id,v.id));for(const k of b){const v=k.dx>0?(d.cx??1)-1:0,S=k.dy>0?(d.cy??1)-1:0;p(k,m+v+k.dx,x+S+k.dy)}};p(c,h,u);for(const[d,m,x]of a)if((d.x!==void 0||d.y!==void 0)&&(d.x!==m||d.y!==x))return!1;const y=new Set(a.map(([d])=>d)),g=new Set;for(const[d,m,x]of a){const b=d.cx??1,k=d.cy??1;for(let v=0;v<b;v++)for(let S=0;S<k;S++){const E=`${m+v},${x+S}`;if(g.has(E))return!1;g.add(E);const $=i.get(E);if($){if($ instanceof $t){if(!y.has($))return!1;continue}if($ instanceof Wt){if(!y.has($.node))return!1;continue}return!1}}}for(const[d,m,x]of a)if(!(d.x!==void 0&&d.y!==void 0)&&!r(d,m,x))return!1;return!0}return r(e,t,n)}function ne(i,e,t){const n=[],o=i.x,s=i.y;for(let r=0;r<t.length;r+=2){const c=t[r],f=t[r+1];i.x=c,i.y=f;const l=i.nearPlaces(e,1,void 0,!0,void 0),h=i.cx??1,u=i.cy??1;l.push(c-1,f-1),l.push(c-1,f+u),l.push(c+h,f+u),l.push(c+h,f-1);let a=!1;for(let w=0;w<l.length;w+=2){const p=l[w],y=l[w+1],g=e.get(`${p},${y}`);if(g instanceof $t||g instanceof Wt||g instanceof R||g instanceof ot||g instanceof ge){a=!0;break}}a||n.push(c,f)}return i.x=o,i.y=s,n}function Me(i,e){for(const t of e.cells)i.delete(`${t.x},${t.y}`);e.clearCells()}function lo(i,e){if(e.origin&&e.origin!==e||e.children.size>0){const r=e.findGrandparent(),c=new Set,f=l=>{if(c.has(l))return;c.add(l);const h=[...l.children.values()].sort((u,a)=>it(u.id,a.id));for(const u of h)f(u);if(l.x!==void 0&&l.y!==void 0){const u=l.x,a=l.y,w=l.cx??1,p=l.cy??1;for(let y=0;y<w;y++)for(let g=0;g<p;g++)i.delete(`${u+y},${a+g}`);l.x=void 0,l.y=void 0}l.cache=Object.create(null);for(const u of l.edges())Me(i,u)};f(r);return}if(e.x===void 0||e.y===void 0)return;const t=e.x,n=e.y,o=e.cx??1,s=e.cy??1;for(let r=0;r<o;r++)for(let c=0;c<s;c++)i.delete(`${t+r},${n+c}`);e.x=void 0,e.y=void 0,e.cache=Object.create(null);for(const r of e.edges())Me(i,r)}function oe(i,e,t,n,o,s,r,c){if(o.x!==void 0&&o.y!==void 0)return;if(o.origin&&o.origin!==o){const x=o.origin;if(x.x!==void 0&&x.y!==void 0){const b=o.dx>0?(x.cx??1)-1:0,k=o.dy>0?(x.cy??1)-1:0,v=x.x+b+o.dx,S=x.y+k+o.dy;if(It(e,o,v,S,t,n))return}}const f=s??0;if((o.rank??-1)>=0){const x=Math.abs(o.rank??0),b=on(n),k=t.get(x);if(k!==void 0){let v=0,S=0;for(b==="x"?v=k:S=k;;){if(It(e,o,v,S,t,n))return;b==="x"?v+=2:S+=2}}}let l=c;if(!l){const x=[...o.edges()].sort((b,k)=>it(String(b.id),String(k.id)));x.length>0&&(l=x[0])}let h=2;if(c){const x=c.attribute("minlen").trim();let b=x===""?1:Number(x);if(!Number.isFinite(b))throw new Error(`Invalid edge minlen: ${c.attribute("minlen")}`);b=Math.abs(b),b<1&&(b=1),h=b+1}if(l&&o.edges().length>0){const x=C=>C===270?[0,-1]:C===90?[0,1]:C===0?[1,0]:C===180?[-1,0]:[0,1],b=C=>{for(const P of C)if(P.x!==void 0&&P.y!==void 0)return[P.x,P.y]},k=(C,P,M)=>{const G=new Map;for(const T of he(C,"start",P,M)){const I=T.to;I!==C&&G.set(I.id,I)}return[...G.entries()].sort((T,I)=>it(T[0],I[0])).map(([,T])=>T)},v=(C,P,M)=>{const G=new Map;for(const T of he(C,"end",P,M)){const I=T.from;I!==C&&G.set(I.id,I)}return[...G.entries()].sort((T,I)=>it(T[0],I[0])).map(([,T])=>T)},S=()=>{h<3&&(h=3),l.labelText()!==""&&(h+=1)},E=C=>{const[P,M]=C,[G,T]=x(o.flow());let I=2;for(;;I+=2){const tt=P+G*I,ut=M+T*I;if(ne(o,e,[tt,ut]).length!==0&&It(e,o,tt,ut,t,n))return}},[$,N]=l.port("start");if($!==void 0&&N!==void 0){const C=k(l.from,$,N);if(C.length>1){S();const P=b(C);if(P){E(P);return}}}const[A,L]=l.port("end");if(A!==void 0&&L!==void 0){const C=v(l.to,A,L);if(C.length>1){S();const P=b(C);if(P&&C.some(M=>M===o)){E(P);return}}}}const u=l?l.flow():void 0;if(r&&r.x!==void 0&&r.y!==void 0){const x=o.id==="U"&&r.id==="B",b=v=>v?v instanceof $t?{kind:"Node",id:v.id,x:v.x,y:v.y,cx:v.cx??1,cy:v.cy??1}:v instanceof Wt?{kind:"NodeCell",nodeId:v.node.id}:v instanceof R?{kind:"EdgeCell",edgeId:v.edge?.id,type:v.type}:v instanceof ot?{kind:"GroupCell",name:v.group.name}:v instanceof ge?{kind:"EdgeCellEmpty"}:{kind:typeof v}:null;let k;if(x){const v=r.nearPlaces(e,h,void 0,!0,u);k=r.nearPlaces(e,h,void 0,!1,u);const S=new Set;for(let $=0;$<k.length;$+=2)S.add(`${k[$]},${k[$+1]}`);const E=[];for(let $=0;$<v.length;$+=2){const N=v[$],A=v[$+1],L=`${N},${A}`;S.has(L)||E.push({x:N,y:A,cell:b(e.get(L))})}Dt(),o.id,r.id,r.x,r.y,r.cx,r.cy,l?.id}else k=r.nearPlaces(e,h,void 0,!1,u);k=ne(o,e,k),x&&(Dt(),o.id,r.id,void 0),f>0&&(k=k.slice(f));for(let v=0;v<k.length;v+=2){const S=k[v],E=k[v+1];if(x&&(Dt(),o.id,r.id,l?.id,b(e.get(`${S},${E}`)),void 0),It(e,o,S,E,t,n)){x&&(Dt(),o.id,r.id,l?.id,void 0);return}}}if(f===0&&It(e,o,0,0,t,n))return;let a=[],p=o.predecessors().filter(x=>x.x!==void 0&&x.y!==void 0);if(p=p.sort((x,b)=>(b.rank??0)-(x.rank??0)),p.length>0&&p.length<=2)if(p.length===1)a.push(...p[0].nearPlaces(e,h,void 0,!1,void 0)),a.push(...p[0].nearPlaces(e,h+2,void 0,!1,void 0));else{const x=p[0].x-p[1].x,b=p[0].y-p[1].y;x!==0&&b!==0?(a.push(p[0].x,p[1].y),a.push(p[0].y,p[1].x)):x===0?a.push(p[1].x,p[1].y+Math.trunc(b/2)):a.push(p[1].x+Math.trunc(x/2),p[1].y);for(const k of p)a.push(...k.nearPlaces(e,h,void 0,!1,void 0))}const g=o.successors().filter(x=>x.x!==void 0&&x.y!==void 0);for(const x of g)a.push(...x.nearPlaces(e,h,void 0,!1,void 0)),a.push(...x.nearPlaces(e,h+2,void 0,!1,void 0));a=ne(o,e,a),f>0&&(a=a.slice(f));for(let x=0;x<a.length;x+=2){const b=a[x],k=a[x+1];if(It(e,o,b,k,t,n))return}let d=0;p.length>0&&(d=(o.rank??0)*2,d=p[0].x);let m=0;for(;e.has(`${d},${m}`);)m+=2;for(e.has(`${d},${m-1}`)&&(m+=1);;){if(ne(o,e,[d,m]).length!==0&&It(e,o,d,m,t,n))return;m+=2}}function fo(i,e,t,n){if(e.from.x===void 0||e.from.y===void 0||e.to.x===void 0||e.to.y===void 0)throw new Error(`Edge ${e.id} connects unplaced nodes`);const o=e.to.x-e.from.x,s=e.to.y-e.from.y,r=e.from.x+t,c=e.from.y+n;if(Math.abs(o)!==2&&Math.abs(s)!==2||i.has(`${r},${c}`))return;let f;if(e.undirected)f=Y+(n===0?vn:En);else{const l=[r,c,Y+(n===0?_:O)];ie(e,l,t,n),f=l[2]}return e.to.attribute("shape")==="edge"&&(t>0?f&=~Q:t<0&&(f&=~X)),e.from.attribute("shape")==="edge"&&(f&=~Gt),[r,c,f]}const ho=.001;function Ge(i,e,t,n,o,s,r){let c=1;if(i!==void 0&&e!==void 0&&r){const f=r.get(`${i},${e}`);c+=f instanceof R?30:0}if(o!==void 0&&s!==void 0){const f=pt(o-t),l=pt(s-n),h=pt(t-(i??0)),u=pt(n-(e??0));c+=f===h||l===u?0:6}return c}function se(i,e,t,n){let o=Math.abs(t-i);const s=Math.abs(n-e);return o!==0&&s!==0&&(o+=1),o+s}function uo(i){let e=1e7,t=1e7,n=-1e7,o=-1e7;for(const r of i.keys()){const[c,f]=r.split(","),l=Number(c),h=Number(f);l<e&&(e=l),h<t&&(t=h),l>n&&(n=l),h>o&&(o=h)}const s=1;return e-=s,t-=s,n+=s,o+=s,[e,t,n,o]}function po(i,e,t,n,o,s,r,c){let f=[i+1,e,i,e+1,i-1,e,i,e-1],l=rt;const h=t.get(`${i},${e}`);h instanceof R&&(l=h.type),l===_?f=[i,e+1,i,e-1]:l===O&&(f=[i+1,e,i-1,e]);const u=[];for(let a=0;a<f.length;a+=2){const w=f[a],p=f[a+1];if(w<o||w>r||p<s||p>c)continue;const y=`${w},${p}`;if(n.has(y))continue;const g=t.get(y);if(g instanceof R){const d=g.type;(d===_||d===O)&&u.push(w,p);continue}g||u.push(w,p)}return u}const go=[[H,nt,H,0,-1,2,1,_,O,1,0,0,-1],[H,nt,H,-1,0,1,2,O,_,0,1,-1,0],[nt,H,nt,0,-1,1,2,O,_,0,-1,1,0],[nt,H,nt,-1,0,2,1,_,O,-1,0,0,1],[Z,K,Z,0,1,2,1,_,O,1,0,0,1],[Z,K,Z,-1,0,1,2,O,_,0,-1,-1,0],[K,Z,K,1,0,1,2,O,_,0,1,1,0],[K,Z,K,0,-1,2,1,_,O,-1,0,0,-1]];function wo(i,e,t){let n=0;t:for(;n<e.length-2;){const o=e[n],s=e[n+1],r=e[n+2],c=s[1]-o[1],f=s[2]-o[2];for(const l of go){if(o[0]!==l[0]||s[0]!==l[1]||r[0]!==l[2]||c!==l[3]||f!==l[4])continue;let h=o[l[5]],u=r[l[6]];if(l[5]===2){const b=h;h=u,u=b}if(t.has(`${h},${u}`))continue t;let a=o[1],w=o[2];const p=[];a===h&&w===u&&p.push(h,u,l[0]);let y=l[9],g=l[10];for(;a!==h||w!==u;){if(t.has(`${a},${w}`))continue t;p.push(a,w,l[7]),a+=y,w+=g}for(a=h,w=u,y=l[11],g=l[12];a!==r[1]||w!==r[2];){if(t.has(`${a},${w}`))continue t;p.push(a,w,l[8]),a===h&&w===u&&(p[p.length-1]=l[0]),a+=y,w+=g}p.push(a,w,l[8]);const d=o[3]-r[3]?-3:3;let m=0,x=o[3]+d;for(;m<p.length;){const b=x<0?i.length+x:x;i[b]=p[m],i[b+1]=p[m+1],i[b+2]=p[m+2],x+=d,m+=3}}n++}}function yo(i,e,t,n,o){const s=new io,r=new Map,c=new Map,[f,l,h,u]=uo(i);Dt(),Math.floor(e.length/5),Math.floor(t.length/o);const a=2e6;let w=0,p=0,y=0,g=0;for(;y<e.length;){const N=e[y],A=e[y+1],L=e[y+2],C=e[y+3],P=e[y+4];y+=5;const M=`${N},${A}`,G=i.get(M);if(G&&!(G instanceof R))continue;let T=0;if(G instanceof R&&(T=G.type&ce,T!==0&&T!==_&&T!==O))continue;let I=se(N,A,t[0],t[1]);for(let j=o;j<t.length;j+=o){const Nt=se(N,A,t[j],t[j+1]);Nt<I&&(I=Nt)}let tt=0;T!==0&&(tt=30),tt+=Ge(C,P,N,A,N,A),s.add([I,N,A,C,P,L,1]);const ut=tt+g+I;r.set(M,ut),g+=ho,p+=1}if(p===0){n.id,n.from.id,n.from.x,n.from.y,n.from.cx,n.from.cy,n.to.id,n.to.x,n.to.y,n.to.cx,n.to.cy,e.slice(0,15),t.slice(0,o*3);return}let d,m=!1;t:for(;(d=s.extractTop())!==void 0;){if(w++>a){n.id,n.from.id,n.from.x,n.from.y,n.from.cx,n.from.cy,n.to.id,n.to.x,n.to.y,n.to.cx,n.to.cy,c.size;return}const[N,A,L,C,P,M,G]=d,T=`${A},${L}`,I=r.get(T)??0,tt=[C,P,N-I,I,M,G,void 0,void 0];c.set(T,tt),r.delete(T);for(let j=0;j<t.length;j+=o)if(A===t[j]&&L===t[j+1]){tt[4]=(tt[4]??0)+t[j+2],o>3&&(tt[6]=t[j+3],tt[7]=t[j+4]),m=!0;break t}const ut=po(A,L,i,c,f,l,h,u);for(let j=0;j<ut.length;j+=2){const Nt=ut[j],Ht=ut[j+1];let we=I;C!==void 0&&P!==void 0&&(we+=Ge(C,P,A,L,Nt,Ht,i));const Pe=`${Nt},${Ht}`;if(r.has(Pe))continue;let ye=se(Nt,Ht,t[0],t[1]);for(let te=o;te<t.length;te+=o){const Le=se(Nt,Ht,t[te],t[te+1]);Le<ye&&(ye=Le)}s.add([ye+we,Nt,Ht,A,L,void 0,void 0]),r.set(Pe,we)}}if(!m||!d){n.id,n.from.id,n.from.x,n.from.y,n.from.cx,n.from.cy,n.to.id,n.to.x,n.to.y,n.to.cx,n.to.cy,c.size,r.size;return}const x=[];let b=d[1],k=d[2],v,S;const E=[];let $=0;for(;;){const N=`${b},${k}`,A=c.get(N);if(!A)break;let L=A[4]??0,C=A[0],P=A[1];if((L&B)===0){const T=L&ht;(C===void 0||P===void 0)&&(C=b,P=k,(T&at)!==0&&P++,(T&lt)!==0&&P--,(T&Q)!==0&&C++,(T&X)!==0&&C--),(v===void 0||S===void 0)&&A[6]!==void 0&&A[7]!==void 0&&(v=A[6],S=A[7]),(v===void 0||S===void 0)&&(v=b,S=k,(T&W)!==0&&S++,(T&q)!==0&&S--,(T&J)!==0&&v++,(T&V)!==0&&v--),L+=Ae(C,P,b,k,v,S)}(L&B)===0&&(L=_);const G=L&B;if((L===nt||G===Z||G===K||G===H)&&E.push([L,b,k,-$]),x.unshift(b,k,L),A[5])break;v=b,S=k,b=A[0],k=A[1],$+=3}E.length>=3&&wo(x,E,i);for(let N=x.length-3;N>=0;N-=3){const A=x[N],L=x[N+1],C=x[N+2],P=C&B;if(!(P!==_&&P!==O)&&!i.has(`${A},${L}`)){(C&Y)===0&&(x[N+2]=C+Y);break}}return x}const sn={[O]:[-1,0,mt,1,0,yt],[_]:[0,-1,wt,0,1,gt],[K]:[0,1,yt,-1,0,wt],[H]:[0,1,mt,1,0,wt],[nt]:[0,-1,yt,-1,0,gt],[Z]:[0,-1,mt,1,0,gt]},mo=sn;function he(i,e,t,n){const o=[];for(const s of i.edges()){if(s.to===i&&e==="start"||s.from===i&&e==="end")continue;const[r,c]=s.port(e);r!==void 0&&c!==void 0&&r===t&&c===n&&o.push(s)}return o}function Re(i,e,t,n,o){for(const c of i)for(const f of c.cells){const l=f.type&B,h=o[l];if(!h||(l===_||l===O)&&f.type&e)continue;const u=f.x,a=f.y;for(let w=0;w<h.length;w+=3){const p=u+h[w],y=a+h[w+1],g=h[w+2],d=`${p},${y}`;n.has(d)||(n.set(d,[p,y,0,u,a]),t.set(d,g+(f.type&ht)))}}const s=[],r=[...n.keys()].sort(it);for(const c of r){const f=n.get(c);f&&s.push(...f)}return s}function De(i,e,t,n,o){let s=[mt+X,wt+lt,yt+Q,gt+at];(o||e.bidirectional)&&(s=[mt+V,wt+q,yt+J,gt+W]);const r=i.nearPlaces(n,1,s,!0,void 0);for(let c=0;c<r.length;c+=3){const f=r[c],l=r[c+1],h=r[c+2],u=n.get(`${f},${l}`);if(!(u instanceof R))continue;const a=u.type&B;if(!(a!==_&&a!==O)&&t.some(w=>w===u.edge))return u.makeJoint(e,h),new R(e,f,l,Se),[]}}function Be(i,e){const t=e.from,n=e.to;if(t.x===void 0||t.y===void 0||n.x===void 0||n.y===void 0)throw new Error(`Edge ${e.id} connects unplaced nodes`);let o=[X,lt,Q,at],s=[V,q,J,W];e.to.attribute("shape")==="edge"&&(s=[0,0,0,0]),e.from.attribute("shape")==="edge"&&(o=[0,0,0,0]);const[r,c]=e.port("start"),[f,l]=e.port("end"),h=new Map,u=new Map,a=new Map,w=new Map;let p=5,y;if(f!==void 0&&l!==void 0){const x=he(n,"end",f,l).filter(b=>b.cells.length>0);if(x.length>0){const b=De(t,e,x,i);if(b)return b;y=Re(x,Gt,u,w,mo)}else y=n.nearPlaces(i,1,s,!0,void 0),y=n.allowedPlaces(y,n.allow(f,l),3),p=3}else y=n.nearPlaces(i,1,s,!0,void 0),f!==void 0&&(y=n.allowedPlaces(y,n.allow(f,l),3)),p=3;if(y.length===0){Dt(),e.id,t.id,t.x,t.y,t.cx,t.cy,n.id,n.x,n.y,n.cx,n.cy;return}let g=[];if(r!==void 0&&c!==void 0){const x=he(t,"start",r,c).filter(b=>b.cells.length>0);if(x.length>0){const b=De(n,e,x,i,!0);if(b)return b;g=Re(x,Ft,h,a,sn)}}if(g.length===0){const m=e.bidirectional?s:o;let x=t.nearPlaces(i,1,m,!0,t.shift(-90));if(r!==void 0&&(x=t.allowedPlaces(x,t.allow(r,c),3)),x.length===0){Dt(),e.id,t.id,t.x,t.y,t.cx,t.cy,n.id,n.x,n.y,n.cx,n.cy;return}for(let b=0;b<x.length;b+=3){const k=x[b],v=x[b+1],S=x[b+2];let E=k,$=v;const N=t.y,A=t.x;t.cx;const L=t.cy??1;v<N||v>=N+L?(v<N&&($=v+1),v>N&&($=v-1)):(k<A&&(E=k+1),k>A&&(E=k-1)),g.push(k,v,S,E,$)}}const d=yo(i,g,y,e,p);if(d){if(d.length>0&&a.size>0){const m=d[0],x=d[1],b=`${m},${x}`,k=a.get(b);if(k){const v=k[3],S=k[4],E=h.get(b),$=i.get(`${v},${S}`);if(!($ instanceof R)||E===void 0)throw new Error(`Unable to convert start joint at ${v},${S} for edge ${e.id}`);$.makeJoint(e,E)}}if(d.length>0&&w.size>0){const m=d[d.length-3],x=d[d.length-2],b=`${m},${x}`,k=w.get(b);if(k){const v=k[3],S=k[4],E=u.get(b),$=i.get(`${v},${S}`);if(!($ instanceof R)||E===void 0)throw new Error(`Unable to convert end joint at ${v},${S} for edge ${e.id}`);$.makeJoint(e,E)}}return d}}function xo(i,e){const t=e.from,n=t.nearPlaces(i,1,[Kt,qt,Jt,Vt],!1,90),o=t.flow();let s=[Vt,qt,Jt,Kt];o===270?s=[qt,Vt,Kt,Jt]:o===0?s=[Jt,Kt,qt,Vt]:o===180&&(s=[Kt,Jt,Vt,qt]);for(const r of s)for(let c=0;c<n.length;c+=3){if(n[c+2]!==r)continue;const f=n[c],l=n[c+1];if(!i.has(`${f},${l}`))return[f,l,r]}}function bo(i,e,t){const n=t.from,o=t.to;if(n===o)return xo(e,t);if((n.cx??1)!==1||(n.cy??1)!==1||(o.cx??1)!==1||(o.cy??1)!==1||t.hasPorts())return Be(e,t);if(n.x===void 0||n.y===void 0||o.x===void 0||o.y===void 0)throw new Error(`Edge ${t.id} connects unplaced nodes`);const s=n.x,r=n.y,c=o.x,f=o.y,l=pt(c-s),h=pt(f-r);if(l===0||h===0){const a=fo(e,t,l,h);if(a)return a;const w=l===0?O:_;let p=!1,y=0;const g=[];let d=s+l,m=r+h;for(;;){if(e.has(`${d},${m}`)){p=!0;break}let x=w;if(y++===0&&(x+=Y),g.push(d,m,x),d+=l,m+=h,d===c&&m===f)break}if(!p)return ie(t,g,l,h),g}else{let a=0,w=[],p=s,y=r,g=_,d=0;for(t.label===""&&(d=1),p+=l;p!==c;){if(e.has(`${p},${y}`)){a++;break}let m=g;d++===0&&(m+=Y),w.push(p,y,m),p+=l}if(a===0&&e.has(`${p},${y}`)&&a++,a===0){const m=Ae(p-l,y,p,y,p,y+h);for(w.push(p,y,m),y+=h,g=O;y!==f;){if(e.has(`${p},${y}`)){a++;break}w.push(p,y,g),y+=h}}if(a===0)return ie(t,w,l,h),w;for(a=0,w=[],p=s,y=r+h,g=O;y!==f;){if(e.has(`${p},${y}`)){a++;break}w.push(p,y,g),y+=h}if(a===0&&e.has(`${p},${y}`)&&a++,a===0){const m=Ae(p,y-h,p,y,p+l,y);for(w.push(p,y,m),p+=l,d=0,t.label===""&&(d=1),g=_;p!==c;){if(e.has(`${p},${y}`)){a++;break}let x=g;d++===0&&(x+=Y),w.push(p,y,x),p+=l}}if(a===0)return ie(t,w,l,h),w}const u=Be(e,t);if(u!==void 0)return u}function We(i){switch(i){case rt:return 15;case _:return 10;case O:return 5;case K:return 3;case H:return 9;case nt:return 6;case Z:return 12;case gt:return 14;case wt:return 11;case yt:return 7;case mt:return 13;default:return 0}}function vo(i){switch(i){case 15:return rt;case 10:return _;case 5:return O;case 3:return K;case 9:return H;case 6:return nt;case 12:return Z;case 14:return gt;case 11:return wt;case 7:return yt;case 13:return mt;default:return}}function Eo(i,e,t,n,o){const s=`${t},${n}`,r=i.get(s);if(r instanceof R){const f=r.type&B,l=o&B,h=vo(We(f)|We(l));if(h===void 0)throw new Error(`Cannot merge edge cell types at ${t},${n} (${f} vs ${l})`);const u=r.type&ht|o&ht,a=r.type&B,w=o&B;h===rt&&(a===_||a===O)&&(w===_||w===O)?r.makeCross(e,u):r.type=h+u,new R(e,t,n,Se);return}if(r)throw new Error(`Cannot place edge cell at occupied ${t},${n}`);const c=new R(e,t,n,o);i.set(s,c)}function ko(i,e,t){if(t.from.x===void 0||t.from.y===void 0||t.to.x===void 0||t.to.y===void 0)throw new Error(`Edge ${t.id} connects unplaced nodes`);const n=bo(i,e,t);if(n){if(n.length===0)return 0;for(let o=0;o<n.length;o+=3){const s=n[o],r=n[o+1],c=n[o+2];Eo(e,t,s,r,c)}return 0}}function $o(i,e){for(const t of i.edges){const n=t.cells;if(n.length<2)continue;let o=n[0],s=1;for(;s<n.length;){const r=n[s],c=o.type&ce,f=r.type&ce;if(c===f&&(c===_||c===O)){o.type|=r.type&Je;const l=c===_,h=(l?r.cx:r.cy)??1;l?o.cx=(o.cx??1)+h:o.cy=(o.cy??1)+h,e.delete(`${r.x},${r.y}`);let u=r.x,a=r.y;(l&&o.x>r.x||!l&&o.y>r.y)&&(u=o.x,a=o.y,e.delete(`${o.x},${o.y}`),l?o.x-=h:o.y-=h,e.set(`${o.x},${o.y}`,o)),n.splice(s,1);const w=`${u},${a}`;e.has(w)||e.set(w,new ge(u,a));continue}if(r.type===Se){if(n.splice(s,1),s>=n.length)break;o=n[s],s++;continue}o=r,s++}}}function Ao(i){for(const a of i.nodes())a.cache=Object.create(null),a.x=void 0,a.y=void 0,a.w=void 0,a.h=void 0,a.todo=!0,a.chain=void 0,a.chainNext=void 0;for(const a of i.edges)a.clearCells(),a.todo=!0;const e=en(i),t=e?i.node(e):void 0;for(const a of i.nodes())a.grow();co(i,t);const{root:n,chains:o}=ao(i),s=[];n&&s.push(i._layoutAction(Zt,n,0));const r=[...o.values()].sort((a,w)=>{const p=n&&a.start===n?1:0;return(n&&w.start===n?1:0)-p||w.len-a.len||it(a.start.id,w.start.id)});for(const a of r)s.push(...a.layout());const c=[...i.nodes()].sort((a,w)=>it(String(a.numericId),String(w.numericId)));for(const a of c){s.push(i._layoutAction(Zt,a,0));const w=a.edges().filter(p=>p.todo&&p.from===a).sort((p,y)=>it(p.to.id,y.to.id));for(const p of w)s.push([zt,p]),p.todo=!1}i.groups.length>0&&s.push([Ie]);let f=new Map;const l=new Map,h=i.flow();let u=16;for(;s.length>0;){const a=s.shift(),w=a[0];let p,y,g;if(w===Zt){const d=a[1],m=a[2],x=a[3];(d.x===void 0||d.y===void 0)&&oe(i,f,l,h,d,m,void 0,x),p=0}else if(w===fe){const d=a[1],m=a[2],x=a[3],b=a[4];(d.x===void 0||d.y===void 0)&&oe(i,f,l,h,d,m,x,b),p=0}else if(w===zt){const d=a[1];y=d.from,g=d.to,(g.x===void 0||g.y===void 0)&&oe(i,f,l,h,g,0,void 0,d),(y.x===void 0||y.y===void 0)&&oe(i,f,l,h,y,0,void 0,d),p=ko(i,f,d)}else if(w===Ie)f=eo(i,f),p=0;else throw new Error(`Illegal action ${String(w)} on layout stack`);if(p===void 0){if(w===Zt||w===fe){const d=a[1];if(d.x!==void 0&&d.y!==void 0&&lo(f,d),a[2]=a[2]+1,u--,u===0)break;s.unshift(a);continue}if(u--,u===0)break;continue}}return $o(i,f),f}function So(i,e){const t=i.replace(/[<>]/g,""),n=e.replace(/[<>]/g,""),o=t+n;return o.includes("~~")?"wave":o.includes("..-")?"dot-dot-dash":o.includes(".-")?"dot-dash":o.includes("..")?"dotted":o.includes("= ")?"double-dash":o.includes("- ")?"dashed":o.includes("==")?"double":o.includes("=")?"double-dash":(o.includes("--")||o.includes("-"),"solid")}class Ce{id="";timeout=360;seed=0;graphAttributes=Object.create(null);defaultNodeAttributes=Object.create(null);defaultEdgeAttributes=Object.create(null);defaultGroupAttributes=Object.create(null);nodeClassAttributes=new Map;edgeClassAttributes=new Map;groupClassAttributes=new Map;nodesById=new Map;nextNodeId=1;nextEdgeId=1;edges=[];groups=[];cells;node(e){return this.nodesById.get(e)}nodes(){return this.nodesById.values()}getNodeCount(){return this.nodesById.size}flow(){const e=this.graphAttributes.flow;if(!e)return 90;const t=e.trim().toLowerCase();if(t==="0"||t==="90"||t==="180"||t==="270")return Number(t);if(t==="east"||t==="right"||t==="forward"||t==="front")return 90;if(t==="west"||t==="left"||t==="back")return 270;if(t==="north"||t==="up")return 0;if(t==="south"||t==="down")return 180;throw new Error(`Invalid graph flow: ${e}`)}setGraphAttributes(e){ct(this.graphAttributes,e)}setDefaultAttributes(e,t){ct(e==="node"?this.defaultNodeAttributes:e==="edge"?this.defaultEdgeAttributes:this.defaultGroupAttributes,t)}setClassAttributes(e,t,n){const o=e==="node"?this.nodeClassAttributes:e==="edge"?this.edgeClassAttributes:this.groupClassAttributes,s=t.trim().toLowerCase(),r=o.get(s);if(r){ct(r,n);return}const c=Object.create(null);ct(c,n),o.set(s,c)}addNode(e){const t=e,n=this.nodesById.get(t);if(n)return n;const o=new $t(t,e,this.nextNodeId++);return o.graph=this,o.setAttributes(this.defaultNodeAttributes),this.nodesById.set(t,o),o}addEdge(e,t,n,o,s){const r=n.includes("<")||o.includes("<"),c=n.includes(">")||o.includes(">");let f=e,l=t;const h=r&&c,u=!r&&!c;!h&&!u&&r&&!c&&(f=t,l=e);const a=new pn(this.nextEdgeId++,f,l,n,o,s);return a.setAttributes(this.defaultEdgeAttributes),a.attribute("style").trim()===""&&a.setAttributes({style:So(n,o)}),a.graph=this,a.bidirectional=h,a.undirected=u,f.addEdge(a),l.addEdge(a),this.edges.push(a),a}addGroup(e){e.graph=this,this.groups.push(e)}deleteNode(e){const t=this.nodesById.get(e);if(!t)return;this.nodesById.delete(e);for(let o=this.edges.length-1;o>=0;o--){const s=this.edges[o];(s.from===t||s.to===t)&&(s.from.edgesById.delete(s.id),s.to.edgesById.delete(s.id),this.edges.splice(o,1))}const n=o=>{o.nodes.delete(t);for(const s of o.groups)n(s)};for(const o of this.groups)n(o)}edgesBetween(e,t){const n=[];for(const o of this.edges){if(o.from===e&&o.to===t){n.push(o);continue}(o.bidirectional||o.undirected)&&o.from===t&&o.to===e&&n.push(o)}return n.sort((o,s)=>o.id-s.id),n}_layoutAction(e,t,...n){return t.todo=!1,[e,t,...n]}_edgesIntoGroups(){for(const e of this.edges)e.group=void 0;for(const e of this.edges){const t=e.from.group,n=e.to.group;t&&n&&t===n&&(e.group=t)}}layout(){this._edgesIntoGroups(),this.cells=Ao(this)}asAscii(){return Vn(this)}}class rn{constructor(e){this.name=e}attributes=Object.create(null);nodes=new Set;groups=[];cellsByXY=new Map;graph;parent;setAttributes(e){ct(this.attributes,e)}rawAttribute(e){return this.attributes[e]}attribute(e){const t=this.attributes[e];return t!==void 0?t:e==="textwrap"?this.graph?.graphAttributes.textwrap??"":""}label(){return this.name}addNode(e){this.nodes.add(e),e.group=this}addGroup(e){e.parent=this,e.graph=this.graph,this.groups.push(e)}_clearCells(){this.cellsByXY.clear()}_addCell(e){this.cellsByXY.set(`${e.x},${e.y}`,e)}_delCellAt(e,t){this.cellsByXY.delete(`${e},${t}`)}_setCellTypes(e){for(const t of this.cellsByXY.values())t.setType(e)}_findLabelCell(){const e=this.attribute("align").trim().toLowerCase()||"left",n=this.attribute("labelpos").trim().toLowerCase()==="bottom"?"gb":"gt";let o;const s=[...this.cellsByXY.entries()].sort(([r],[c])=>r.localeCompare(c));for(const[,r]of s)if(r.cellClass.trim()===n){if(o){if(e==="left"){if(o.x<r.x||o.y<r.y)continue}else if(e==="center"){if(o.y<r.y)continue}else if(e==="right"&&(o.x>r.x||o.y<r.y))continue}o=r}if(o&&e==="center"){let r,c;for(const f of this.cellsByXY.values())f.y===o.y&&(r=r===void 0?f.x:Math.min(r,f.x),c=c===void 0?f.x:Math.max(c,f.x));if(r!==void 0&&c!==void 0){const f=Math.trunc((c-r)/2+r);let l;for(const h of this.cellsByXY.values()){if(h.y!==o.y)continue;const u=f-h.x,a=u*u;l!==void 0&&a>l||(l=a,o=h)}}}o?.setLabel()}}function kt(){return Object.create(null)}function No(i){return i.replace(/\r\n?/g,`
`).replace(/\\\n\s*/g," ")}function Co(i){const e=[],t=i;let n=0;const o=c=>e.push({type:"punct",value:c}),s=c=>e.push({type:"edgeOp",value:c}),r=c=>e.push({type:"id",value:c});for(;n<t.length;){const c=t[n];if(/\s/.test(c)){n++;continue}if(c==="#"){for(;n<t.length&&t[n]!==`
`;)n++;continue}if(c==="/"&&t[n+1]==="/"){for(n+=2;n<t.length&&t[n]!==`
`;)n++;continue}if(c==="/"&&t[n+1]==="*"){for(n+=2;n<t.length&&!(t[n]==="*"&&t[n+1]==="/");)n++;n<t.length&&(n+=2);continue}if(c==="-"&&t[n+1]===">"){s("->"),n+=2;continue}if(c==="-"&&t[n+1]==="-"){s("--"),n+=2;continue}if("{}[]();=,:+".includes(c)){o(c),n++;continue}if(c==='"'){n++;let h="";for(;n<t.length;){const u=t[n];if(u==="\\"){if(n+1<t.length){h+=t.slice(n,n+2),n+=2;continue}h+=u,n++;continue}if(u==='"'){n++;break}h+=u,n++}r(h);continue}if(c==="<"){const h=n;for(n++;n<t.length&&t[n]!==">";)n++;if(n>=t.length)throw new Error("Unterminated <...> token in DOT input");n++,r(t.slice(h,n));continue}const f=n;for(;n<t.length;){const h=t[n];if(/\s/.test(h)||h==="#"||h==="/"&&(t[n+1]==="/"||t[n+1]==="*")||'{}[]();=,:+"<>'.includes(h)||h==="-"&&(t[n+1]===">"||t[n+1]==="-"))break;n++}const l=t.slice(f,n);if(l.length){r(l);continue}throw new Error(`Unexpected character in DOT input: ${JSON.stringify(c)}`)}return e}function Po(i){const e=i.trim();return e.startsWith("<")&&e.endsWith(">")?e.slice(1,-1).trim():i}function xe(i){const t=i.trim().toLowerCase().slice(0,1);return t==="n"?"north":t==="s"?"south":t==="e"?"east":t==="w"?"west":"east"}function Lo(i){const e=i.trim().toUpperCase();return e==="LR"?"east":e==="RL"?"west":e==="TB"?"south":e==="BT"?"north":"east"}function je(i){const e=i.trim().toLowerCase();return e==="l"?"left":e==="r"?"right":"center"}function Fe(i){return i.trim().toLowerCase().startsWith("b")?"bottom":"top"}function To(i){let t=i.trim().toLowerCase();return t.startsWith("double")&&(t=t.slice(6)),t.startsWith("triple")&&(t=t.slice(6)),t=t.trim(),t==="plaintext"||t==="none"?"none":t==="box"||t==="polygon"||t==="egg"||t==="rectangle"||t==="msquare"?"rect":t==="mdiamond"?"diamond":t}function _o(i){const e=[];let t="";for(let n=0;n<i.length;n++){const o=i[n];if(o==="\\"&&n+1<i.length){t+=i.slice(n,n+2),n++;continue}if(o==="|"){e.push(t),t="";continue}t+=o}return e.push(t),e}function cn(i){return i.replace(/(^|\|)\s*<[^>]*>/g,"$1")}function Oo(i,e){let t=i;/^\s*\{[^{}]+\}\s*$/.test(t)&&(t=t.replace(/[{}]/g,""),/^(east|west)$/.test(e)&&(t=t.replace(/\|/g,"||  ")),/^(north|south)$/.test(e)&&(t=t.replace(/\|\|/g,"|  |")));const n=_o(t),o=[];for(const r of n){const c=/^\s*<([^>]*)>/.exec(r);o.push(c?c[1]:void 0)}let s=cn(t);return s=s.trim(),s=s.replace(/\|\s\|/g,"|  |"),{displayLabel:s,ports:o}}function Io(i,e){for(const[t,n]of Object.entries(e))t in i.attributes||(i.attributes[t]=n)}class Mo{tokens;pos=0;graph=new Ce;groupStack=[];edgeSpecs=[];defaultEdgeLabel="";constructor(e){const t=No(e);this.tokens=Co(t),this.graph.setGraphAttributes({colorscheme:"x11",flow:"south"}),this.graph.setDefaultAttributes("edge",{arrowstyle:"filled"}),this.graph.setDefaultAttributes("group",{align:"center",fill:"inherit"})}parse(){this.peekIdValueCi("strict")&&this.pos++;const e=this.consumeId(),t=e.toLowerCase();if(t!=="graph"&&t!=="digraph")throw new Error(`Expected 'graph' or 'digraph', got: ${e}`);const n=this.peekPunct("{")?"":this.parseIdExpr().trim();for(n&&this.graph.setGraphAttributes({title:n}),this.expectPunct("{");!this.peekPunct("}")&&!this.isEof();)for(this.parseStatement();this.peekPunct(";")||this.peekPunct(",");)this.pos++;this.expectPunct("}");const o=this.splitRecordNodes();return this.materializeEdges(o),this.graph}currentGroup(){return this.groupStack.length?this.groupStack[this.groupStack.length-1]:void 0}addNodeToCurrentGroup(e){const t=this.currentGroup();t&&t.addNode(e)}openGroup(e){const t=new rn(e);t.setAttributes(this.graph.defaultGroupAttributes);const n=this.currentGroup();return n?n.addGroup(t):this.graph.addGroup(t),this.groupStack.push(t),t}closeGroup(){if(!this.groupStack.pop())throw new Error("Encountered end of subgraph with no open group")}parseStatement(){if(this.isEof()||this.peekPunct("}"))return;if(this.peekIdValueCi("subgraph")){this.parseSubgraph();return}if(this.peekPunct("{")){const n=this.parseNodeSetEndpoint();this.peekEdgeOp()&&this.parseEdgeStatement(n);return}if(this.peekIdValueCi("graph")||this.peekIdValueCi("node")||this.peekIdValueCi("edge")){const n=this.peekToken();if(n?.type==="id"){const o=this.tokens[this.pos+1];if(o?.type==="punct"&&o.value==="["){this.pos++;const s=this.parseAttrList(),r=n.value.toLowerCase();r==="graph"?this.applyGraphAttrs(s):r==="node"?this.applyNodeDefaults(s):this.applyEdgeDefaults(s);return}}}const e=this.parseNodeRef();if(this.peekPunct("=")){this.pos++;const n=this.parseIdExpr();this.applyAssignment(e.id,n);return}if(this.peekEdgeOp()){this.parseEdgeStatement({refs:[e],contributesToEdges:!0});return}const t=this.peekPunct("[")?this.parseAttrList():kt();this.applyNodeStatement(e.id,t)}parseSubgraph(){this.pos++;let e="";for(this.peekPunct("{")||(e=this.parseIdExpr().trim()),this.expectPunct("{"),this.openGroup(e);!this.peekPunct("}")&&!this.isEof();)for(this.parseStatement();this.peekPunct(";")||this.peekPunct(",");)this.pos++;this.expectPunct("}"),this.closeGroup()}parseEdgeStatement(e){const t=[];let n=e;for(;this.peekEdgeOp();){const h=this.consumeEdgeOp()==="->",u=this.parseEndpoint();t.push({from:n,to:u,directed:h}),n=u}const o=this.peekPunct("[")?this.parseAttrList():kt(),{edgeLabel:s,edgeAttrs:r,dirMod:c}=this.remapEdgeAttrs(o),f=s??this.defaultEdgeLabel;for(const l of t){if(!l.from.contributesToEdges||!l.to.contributesToEdges)continue;let h=l.directed;c==="none"&&(h=!1);for(const u of l.from.refs)for(const a of l.to.refs){let w=u,p=a;c==="back"&&([w,p]=[p,w]);const y=kt();Object.assign(y,r),this.edgeSpecs.push({from:w,to:p,directed:h,label:f,attrs:y})}}}parseEndpoint(){return this.peekPunct("{")?this.parseNodeSetEndpoint():{refs:[this.parseNodeRef()],contributesToEdges:!0}}parseNodeSetEndpoint(){this.expectPunct("{");const e=[],t=kt();let n=!1;for(;!this.peekPunct("}")&&!this.isEof();){if(this.peekPunct(";")||this.peekPunct(",")){this.pos++;continue}const o=this.peekToken(),s=this.tokens[this.pos+1];if(o?.type==="id"&&s?.type==="punct"&&s.value==="["){const f=o.value.toLowerCase();if(f==="node"){n=!0,this.pos++;const l=this.parseAttrList();Object.assign(t,this.remapNodeAttrs(l));continue}if(f==="graph"||f==="edge"){n=!0,this.pos++,this.parseAttrList();continue}}const r=this.parseNodeRef();e.push(r);const c=this.graph.addNode(r.id);Io(c,t)}return this.expectPunct("}"),{refs:e,contributesToEdges:!n}}parseAttrList(){this.expectPunct("[");const e=kt();for(;!this.peekPunct("]")&&!this.isEof();){if(this.peekPunct(",")||this.peekPunct(";")){this.pos++;continue}const t=this.parseIdExpr();if(!t)throw new Error("Empty attribute key in DOT attribute list");if(this.peekPunct("=")){this.pos++;const n=this.parseIdExpr();e[t]=n}else e[t]="true";(this.peekPunct(",")||this.peekPunct(";"))&&this.pos++}return this.expectPunct("]"),e}parseNodeRef(){const e=this.parseIdExpr().trim();let t,n;this.peekPunct(":")&&(this.pos++,t=this.parseIdExpr().trim(),this.peekPunct(":")&&(this.pos++,n=this.parseIdExpr().trim()));const o=this.graph.addNode(e);return this.addNodeToCurrentGroup(o),{id:e,port:t,compass:n}}parseIdExpr(){let e=this.parseIdTerm();for(;this.peekPunct("+");)this.pos++,e+=this.parseIdTerm();return e}parseIdTerm(){const e=this.peekToken();if(!e||e.type!=="id")throw new Error(`Expected identifier, got: ${e?JSON.stringify(e):"<eof>"}`);return this.pos++,Po(e.value)}applyAssignment(e,t){const n=e.trim(),o=t,s=this.currentGroup();if(s){const c=this.remapGroupAttr(n,o);c&&s.setAttributes(c);return}const r=this.remapGraphAttr(n,o);r&&this.graph.setGraphAttributes(r)}applyGraphAttrs(e){const t=this.remapGraphAttrs(e);t&&this.graph.setGraphAttributes(t)}applyNodeDefaults(e){const t=this.remapNodeAttrs(e);t&&this.graph.setDefaultAttributes("node",t)}applyEdgeDefaults(e){const{edgeLabel:t,edgeAttrs:n}=this.remapEdgeAttrs(e);t!==void 0&&(this.defaultEdgeLabel=t),Object.keys(n).length&&this.graph.setDefaultAttributes("edge",n)}applyNodeStatement(e,t){const n=this.graph.addNode(e);this.addNodeToCurrentGroup(n);const o=this.remapNodeAttrs(t);o&&n.setAttributes(o)}remapGraphAttrs(e){const t=kt();for(const[n,o]of Object.entries(e)){const s=n.trim(),r=o,c=this.remapGraphAttr(s,r);c&&Object.assign(t,c)}return t}remapGraphAttr(e,t){const n=e.toLowerCase();return n==="rankdir"?{flow:Lo(t)}:n==="labeljust"?{align:je(t)}:n==="labelloc"?{labelpos:Fe(t)}:n==="label"?{label:t}:n==="colorscheme"?{colorscheme:t}:{[`x-dot-${n}`]:t}}remapGroupAttr(e,t){const n=e.toLowerCase();return n==="label"?{label:t}:n==="labeljust"?{align:je(t)}:n==="labelloc"?{labelpos:Fe(t)}:{[`x-dot-${n}`]:t}}remapNodeAttrs(e){const t=kt();for(const[n,o]of Object.entries(e)){const s=n.trim().toLowerCase(),r=o;if(s==="label"){t.label=r;continue}if(s==="shape"){t.shape=To(r);continue}if(s==="fontsize"){const c=r.trim();t.fontsize=/^\d+(\.\d+)?$/.test(c)?`${c}px`:c;continue}if(s==="fontname"){t.font=r;continue}if(s==="style"){const c=r.split(",").map(f=>f.trim().toLowerCase()).filter(Boolean);for(const f of c)f==="filled"?t.shape="rect":f==="rounded"?t.shape="rounded":f==="invis"?t.shape="invisible":(f==="dotted"||f==="dashed"||f==="bold")&&(t.border=`${f}  black`);continue}if(s==="color"){t.color=r;continue}t[`x-dot-${s}`]=r}return t}remapEdgeAttrs(e){const t=kt();let n,o;for(const[s,r]of Object.entries(e)){const c=s.trim().toLowerCase(),f=r;if(c==="label"){n=f;continue}if(c==="dir"){const l=f.trim().toLowerCase();l==="back"?o="back":l==="none"&&(o="none");continue}if(c==="headport"){t.end=xe(f);continue}if(c==="tailport"){t.start=xe(f);continue}if(c==="style"){let l=f.trim();l==="invis"&&(l="invisible"),l==="normal"&&(l="solid");const h=/setlinewidth\((\d+|\d*\.\d+)\)/.exec(l);if(h){const u=Math.abs(Number(h[1]||1));l="wide",u<3?l="solid":u>=3&&u<5?l="bold":u>=5&&u<11&&(l="broad")}t.style=l;continue}t[`x-dot-${c}`]=f}return{edgeLabel:n,edgeAttrs:t,dirMod:o}}splitRecordNodes(){const e=new Map,t=(this.graph.graphAttributes.flow??"south").toLowerCase(),n=Array.from(this.graph.nodes());for(const o of n){if((o.attributes.shape??"").toLowerCase()!=="record")continue;const r=o.attributes.label??o.label;if(!r.includes("|"))continue;const{displayLabel:c,ports:f}=Oo(r,t),l=o.id,h=cn(l).trim(),u=new Map;for(let a=0;a<f.length;a++){const w=f[a];w&&u.set(w,a)}for(let a=0;a<f.length;a++){const w=`${l}.${a}`,p=this.graph.addNode(w),y=kt();for(const[g,d]of Object.entries(o.attributes))g==="shape"||g==="label"||(y[g]=d);p.setAttributes(y),p.setAttributes({autosplit_basename:l,autosplit_portname:f[a]??String(a)}),delete p.attributes.shape,a===0&&(p.label=c,h!==c&&p.setAttributes({basename:h})),this.addNodeToCurrentGroup(p)}this.graph.deleteNode(l),e.set(l,{primaryId:`${l}.0`,portIndexByName:u})}return e}materializeEdges(e){for(const t of this.edgeSpecs){const n=t.attrs,o=this.resolveNodeRef(t.from,e,"from",n),s=this.resolveNodeRef(t.to,e,"to",n),r=t.directed,c=r?"-->":"--",f=r?t.label?"--":"-->":"--",l=this.graph.addEdge(o,s,f,c,t.label);Object.keys(n).length&&l.setAttributes(n)}}resolveNodeRef(e,t,n,o){const s=e.id,r=t.get(s);let c=s;if(e.port)if(r){const l=r.portIndexByName.get(e.port);c=`${s}.${l??0}`}else c=`${s}:${e.port}`;else r&&(c=r.primaryId);const f=this.graph.addNode(c);if(e.compass){const l=xe(e.compass);n==="from"?o.start=o.start??l:o.end=o.end??l}return f}peekToken(){return this.tokens[this.pos]}isEof(){return this.pos>=this.tokens.length}peekPunct(e){const t=this.peekToken();return!!t&&t.type==="punct"&&t.value===e}expectPunct(e){const t=this.peekToken();if(!t||t.type!=="punct"||t.value!==e)throw new Error(`Expected '${e}', got: ${t?JSON.stringify(t):"<eof>"}`);this.pos++}peekIdValueCi(e){const t=this.peekToken();return!!t&&t.type==="id"&&t.value.toLowerCase()===e}consumeId(){const e=this.peekToken();if(!e||e.type!=="id")throw new Error(`Expected identifier, got: ${e?JSON.stringify(e):"<eof>"}`);return this.pos++,e.value}peekEdgeOp(){const e=this.peekToken();return!!e&&e.type==="edgeOp"}consumeEdgeOp(){const e=this.peekToken();if(!e||e.type!=="edgeOp")throw new Error(`Expected edge operator, got: ${e?JSON.stringify(e):"<eof>"}`);return this.pos++,e.value}}function Go(i){return new Mo(i).parse()}function Ro(){return Object.create(null)}function Do(i){return i.replace(/\r\n?/g,`
`)}function Bo(i){const e=[],t=i;let n=0;const o=c=>e.push({type:"id",value:c}),s=c=>e.push({type:"punct",value:c}),r=c=>e.push({type:"string",value:c});for(;n<t.length;){const c=t[n];if(/\s/.test(c)){n++;continue}if(c==="/"&&t[n+1]==="/"){for(n+=2;n<t.length&&t[n]!==`
`;)n++;continue}if("{}:".includes(c)){s(c),n++;continue}if(c==='"'){n++;let h="";for(;n<t.length;){const u=t[n];if(u==="\\"&&n+1<t.length){h+=t.slice(n,n+2),n+=2;continue}if(u==='"'){n++;break}h+=u,n++}r(h);continue}const f=n;for(;n<t.length;){const h=t[n];if(/\s/.test(h)||h==="/"&&t[n+1]==="/"||'{}:"'.includes(h))break;n++}const l=t.slice(f,n);if(!l)throw new Error("Unexpected empty token while parsing GDL");o(l)}return e}function Wo(i){const e=i.trim();return e==="top_to_bottom"?"south":e==="bottom_to_top"?"north":e==="left_to_right"?"east":e==="right_to_left"?"west":"south"}function jo(i){return i.replace(/\f\d+/g,"")}class Fo{tokens;pos=0;graph=new Ce;edges=[];constructor(e){this.tokens=Bo(Do(e)),this.graph.setDefaultAttributes("edge",{arrowstyle:"filled"}),this.graph.setDefaultAttributes("node",{align:"left"})}parse(){for(this.expectId("graph"),this.expectPunct(":"),this.expectPunct("{");!this.peekPunct("}")&&!this.isEof();){const e=this.consumeId();if(this.expectPunct(":"),e==="node"){this.expectPunct("{"),this.parseNodeBlock(),this.expectPunct("}");continue}if(e==="edge"){this.expectPunct("{"),this.parseEdgeBlock(),this.expectPunct("}");continue}const t=this.parseScalar();this.applyGraphAttr(e,t)}this.expectPunct("}");for(const e of this.edges){const t=this.graph.addNode(e.source),n=this.graph.addNode(e.target);this.graph.addEdge(t,n,"-->","-->","")}return this.graph}parseNodeBlock(){let e;const t=Ro();for(;!this.peekPunct("}")&&!this.isEof();){const o=this.consumeId();this.expectPunct(":");const s=this.parseScalar();if(o==="title"){e=s;continue}if(o==="label"){t.label=jo(s);continue}if(o==="vertical_order"){t["x-vcg-vertical_order"]=s,t.rank=s==="maxdepth"?"1000000":s;continue}t[`x-vcg-${o}`]=s}if(!e)throw new Error("VCG/GDL node missing required 'title' attribute");const n=this.graph.addNode(e);Object.keys(t).length&&n.setAttributes(t)}parseEdgeBlock(){let e,t;for(;!this.peekPunct("}")&&!this.isEof();){const n=this.consumeId();this.expectPunct(":");const o=this.parseScalar();n==="source"?e=o:n==="target"&&(t=o)}if(!e||!t)throw new Error("VCG/GDL edge missing required 'source'/'target' fields");this.edges.push({source:e,target:t})}applyGraphAttr(e,t){if(e==="title"){this.graph.setGraphAttributes({label:t});return}if(e==="orientation"){this.graph.setGraphAttributes({flow:Wo(t)});return}this.graph.setGraphAttributes({[`x-vcg-${e}`]:t})}parseScalar(){const e=this.peekToken();if(!e)throw new Error("Unexpected EOF while parsing GDL");if(e.type==="string")return this.pos++,e.value;if(e.type==="id")return this.pos++,e.value;throw new Error(`Unexpected token while parsing GDL scalar: ${JSON.stringify(e)}`)}peekToken(){return this.tokens[this.pos]}isEof(){return this.pos>=this.tokens.length}peekPunct(e){const t=this.peekToken();return!!t&&t.type==="punct"&&t.value===e}expectPunct(e){const t=this.peekToken();if(!t||t.type!=="punct"||t.value!==e)throw new Error(`Expected '${e}', got: ${t?JSON.stringify(t):"<eof>"}`);this.pos++}expectId(e){const t=this.peekToken();if(!t||t.type!=="id"||t.value!==e)throw new Error(`Expected '${e}', got: ${t?JSON.stringify(t):"<eof>"}`);this.pos++}consumeId(){const e=this.peekToken();if(!e||e.type!=="id")throw new Error(`Expected identifier, got: ${e?JSON.stringify(e):"<eof>"}`);return this.pos++,e.value}}function zo(i){return new Fo(i).parse()}function Uo(){if(typeof require!="function")throw new Error("Parser.fromFile() is only supported in Node.js");return require("fs")}function Ho(){if(typeof require!="function")throw new Error("Parser.fromFile() is only supported in Node.js");return require("path")}function et(i,e){for(;e<i.length&&/\s/.test(i[e]);)e++;return e}function be(i){return/^[\-\.=<>~]/.test(i)}function ze(i){for(let e=0;e<i.length;e++)if(i[e]==="|"&&(e===0||i[e-1]!=="\\"))return!0;return!1}function Vo(i,e=!1){let t=i;return t=t.replace(/\\([\[\(\{\}\]\)\#<>\-\.\=])/g,"$1"),e||(t=t.replace(/\s+/g," ")),t}function ve(i){let e=0,t=0,n=!1;for(let o=0;o<i.length;o++){const s=i[o];if(n){n=!1;continue}if(s==="\\"){n=!0;continue}s==="["?e++:s==="]"&&e>0?e--:s==="{"?t++:s==="}"&&t>0&&t--}return e===0&&t===0}function Ue(i,e){const t=[];let n=0,o=0,s=0,r=!1,c=0;for(let f=0;f<i.length;f++){const l=i[f];if(r){r=!1;continue}if(l==="\\"){r=!0;continue}l==="["?n++:l==="]"&&n>0?n--:l==="{"?o++:l==="}"&&o>0?o--:l==="("?s++:l===")"&&s>0&&s--,l===e&&n===0&&o===0&&s===0&&(t.push(i.slice(c,f)),c=f+1)}return t.push(i.slice(c)),t}function Ee(i,e){if(i[e]!=="[")throw new Error(`Expected '[' at pos ${e}`);let t=e+1,n=!1;for(;t<i.length;t++){const o=i[t];if(n){n=!1;continue}if(o==="\\"){n=!0;continue}if(o==="]")break}if(t>=i.length||i[t]!=="]")throw new Error("Unterminated [...] node label");return{blockText:i.slice(e+1,t),nextPos:t+1}}function Mt(i,e){if(i[e]!=="{")throw new Error(`Expected '{' at pos ${e}`);let t=e+1,n=1;for(;t<i.length;t++){const o=i[t];if(o==="{")n++;else if(o==="}"&&(n--,n===0))break}if(t>=i.length||i[t]!=="}")throw new Error("Unterminated {...} attribute block");return{blockText:i.slice(e,t+1),nextPos:t+1}}function qo(i,e){if(i[e]!=="(")throw new Error(`Expected '(' at pos ${e}`);let t=e+1,n=1,o=0,s=0,r=!1;for(;t<i.length;t++){const c=i[t];if(r){r=!1;continue}if(c==="\\"){r=!0;continue}if(c==="["?o++:c==="]"&&o>0?o--:c==="{"?s++:c==="}"&&s>0&&s--,!(o!==0||s!==0)){if(c==="(")n++;else if(c===")"&&(n--,n===0))break}}if(t>=i.length||i[t]!==")")throw new Error("Unterminated (...) group block");return{blockText:i.slice(e+1,t),nextPos:t+1}}class Jo{graph=new Ce;groupStack=[];lastChainNode;pendingEdge;lastCreatedEdge;lastNodeList;lastParsedNodeAttrs;clusters=new Set;nextClusterId=0;nextAnonId=0;clearLastCreatedEdge(){this.lastCreatedEdge=void 0}parse(e){const t=e.replace(/\r\n?/g,`
`).split(`
`),n=s=>{let r=0,c=!1;for(let f=0;f<s.length;f++){const l=s[f];if(c){c=!1;continue}if(l==="\\"){c=!0;continue}l==="["?r+=1:l==="]"&&r>0&&(r-=1)}return r>0},o=[];for(let s=0;s<t.length;s++){let r=t[s];const c=r.trim();for(/^(graph|node|edge|group|\.[A-Za-z0-9_-]+)$/.test(c)&&s+1<t.length&&t[s+1].trim().startsWith("{")&&(s++,r+=" "+t[s].trim());!ve(r)&&s+1<t.length;){const f=t[s+1],l=f.trim(),h=n(r)?f.trimEnd():l;if(s++,r+=" "+h,l==="}")break}if(ve(r)&&r.trimEnd().endsWith("]")){let l=s+1;for(;l<t.length;){const h=t[l].trim();if(h===""||h.startsWith("#")){l+=1;continue}break}if(l<t.length&&t[l].trim().startsWith("{"))for(s=l,r+=" "+t[s].trim();!ve(r)&&s+1<t.length;){const h=t[s+1],u=h.trim(),a=n(r)?h.trimEnd():u;if(s++,r+=" "+a,u==="}")break}}o.push(r)}for(const s of o)this.parseLogicalLine(s);if(this.pendingEdge)throw new Error("Dangling edge at end of input (missing target node)");if(this.groupStack.length!==0)throw new Error("Unclosed group(s) at end of input");return this.graph}getClusterName(e){let t=e;if(this.clusters.has(t))for(this.nextClusterId===0&&(this.nextClusterId=1);;){const n=`${e}-${this.nextClusterId}`;if(!this.clusters.has(n)){t=n,this.nextClusterId+=1;break}this.nextClusterId+=1}return this.clusters.add(t),t}autosplitNodes(e,t){let n=e.replace(/\s*\|\|?\s*/g,"");const o=t?.basename;o!==void 0&&(n=o),n=n.trim(),n=this.getClusterName(n);const s=t?(()=>{const y=Object.create(null);for(const[g,d]of Object.entries(t))g!=="basename"&&(y[g]=d);return y})():void 0,r=y=>{const g=[];let d="";for(let m=0;m<y.length;m++){const x=y[m];if(x==="\\"&&m+1<y.length&&y[m+1]==="|"){d+="|",m+=1;continue}if(x==="|"){g.push(d),d="";continue}d+=x}return g.push(d),g};let c,f=0,l=0,h=0,u=e,a="",w=0;const p=[];for(;u!=="";){let y=0;for(;y<u.length;){const $=u[y];if($==="|")break;if($==="\\"&&y+1<u.length&&u[y+1]==="|"){y+=2;continue}y+=1}const g=u.slice(0,y),d=g==="";let m="",x=0;y<u.length&&u[y]==="|"&&(y+1<u.length&&u[y+1]==="|"?(m="||",x=2):(m="|",x=1)),u=u.slice(y+x);const b=u;let k=d?" ":g;w===0&&u===""&&(m==="|"||m==="||")&&(w+=1,u+="|");let v=!1;d?v=!0:/^[ ]+$/.test(k)?g.length===1&&(a===""||a==="||"||!(b!==""))?v=!0:k=" ":k=k.trim();const S=`${n}.${h}`,E=this.graph.addNode(S);if(s){const $=Object.create(null);for(const[N,A]of Object.entries(s))if(!((N==="origin"||N==="offset")&&h!==0)){if(ze(A)){const C=r(A)[h];if(C!==void 0){const P=C.trim();P!==""&&($[N]=P)}continue}$[N]=A}Object.keys($).length&&E.setAttributes($)}if(v&&E.setAttributes({shape:"invisible"}),E.label=k,E.setAttributes({autosplit_basename:n,autosplit_xy:`${f},${l}`}),h===0)c=E,o!==void 0&&E.setAttributes({basename:o});else{let $=p[p.length-1],N=1,A=0;if(a==="||"&&($=c,N=0,A=1,c=E),!$)throw new Error(`autosplitNodes: missing origin for ${S}`);E.origin=$,E.dx=N,E.dy=A,$.children.set(E.id,E)}p.push(E),h+=1,a=m,f+=1,m==="||"&&(f=0,l+=1)}return p}currentGroup(){return this.groupStack.length?this.groupStack[this.groupStack.length-1]:void 0}openGroup(e){const t=new rn(e);t.setAttributes(this.graph.defaultGroupAttributes);const n=this.currentGroup();return n?n.addGroup(t):this.graph.addGroup(t),this.groupStack.push(t),t}closeGroup(){const e=this.groupStack.pop();if(!e)throw new Error("Encountered ')' with no open group");return e}parseLogicalLine(e){let t=e.trim();if(!t||t.startsWith("#"))return;let n;if(be(t)&&(n=this.lastNodeList,n&&n.length>0&&(this.lastChainNode=n[0])),this.lastNodeList=void 0,this.pendingEdge&&t.startsWith("{")&&t.endsWith("}")){const u=Et(t);this.pendingEdge.attrs?Object.assign(this.pendingEdge.attrs,u):this.pendingEdge.attrs=u;return}if(this.tryParseScopeAttributes(t))return;const o=Ue(t,","),s=u=>{const a=u.trim();if(!a.startsWith("["))return!1;try{const w=Ee(a,0);let p=et(a,w.nextPos);if(p<a.length&&a[p]==="{"){const y=Mt(a,p);p=et(a,y.nextPos)}return p===a.length}catch{return!1}};if(!this.pendingEdge&&o.length>1){const u=[],a={};let w=!0;for(const p of o){const y=p.trim();if(y){if(u.push(y),!y.startsWith("[")){w=!1;break}try{const g=Ee(y,0);let d=et(y,g.nextPos);if(d<y.length&&y[d]==="{"){const m=Mt(y,d);Object.assign(a,Et(m.blockText)),d=et(y,m.nextPos)}if(d!==y.length){w=!1;break}}catch{w=!1;break}}}if(w&&u.length>1){const p=[];for(const y of u){if(this.parseChainStatement(y)!==y.length)throw new Error(`Unexpected trailing content after node list item: ${y}`);this.lastChainNode&&p.push(this.lastChainNode)}if(Object.keys(a).length)for(const y of p)y.setAttributes(a);this.lastNodeList=p;return}}let r,c=[],f,l=[],h;for(const u of o){let a=u.trim();if(!a)continue;if(r&&s(a)){const g=this.parseNodeAt(a,0),d=g.node,m=g.attrs;if(h&&Object.keys(h).length>0&&(d.setAttributes(h),m&&d.setAttributes(m)),m)for(const b of l)b.setAttributes(m);m&&(h||(h={}),Object.assign(h,m)),l.push(d);const x=this.graph.addEdge(r.from,d,r.leftOp,r.rightOp,r.label);if(r.attrs&&x.setAttributes(r.attrs),f&&f.length>0)for(const b of f){if(b===r.from)continue;const k=this.graph.addEdge(b,d,r.leftOp,r.rightOp,r.label);r.attrs&&k.setAttributes(r.attrs)}this.lastChainNode=d,this.lastParsedNodeAttrs=m;continue}if(r=void 0,f=void 0,l=[],h=void 0,this.clearLastCreatedEdge(),!this.pendingEdge&&o.length>1&&s(a)){if(this.parseChainStatement(a)!==a.length)throw new Error(`Unexpected trailing content after node list item: ${a}`);this.lastChainNode&&c.push(this.lastChainNode);continue}if(a.startsWith("(")&&!a.includes(")")){const g=a.slice(1).trim();this.openGroup(g);continue}if(a.startsWith(")")){const g=this.closeGroup(),d=a.slice(1),m=et(d,0);if(m<d.length&&d[m]==="{"){const x=Mt(d,m);if(g.setAttributes(Et(x.blockText)),et(d,x.nextPos)<d.length)throw new Error(`Unexpected trailing content after ')': ${d}`)}else if(et(d,0)<d.length)throw new Error(`Unexpected trailing content after ')': ${d}`);continue}if(this.pendingEdge&&a.trimStart().startsWith("[")){const g=this.pendingEdge,d=a.trimStart(),m=this.parseNodeAt(d,0),x=m.node;this.lastParsedNodeAttrs=m.attrs;const b=this.graph.addEdge(g.from,x,g.leftOp,g.rightOp,g.label);if(g.attrs&&b.setAttributes(g.attrs),g.fanoutSources&&g.fanoutSources.length>0)for(const k of g.fanoutSources){if(k===g.from)continue;const v=this.graph.addEdge(k,x,g.leftOp,g.rightOp,g.label);g.attrs&&v.setAttributes(g.attrs)}if(this.pendingEdge=void 0,this.lastChainNode=x,a=d.slice(m.nextPos),a=a.trim(),!a)continue}const w=this.graph.edges.length;for(;a.length;){if(a.startsWith(")")){const d=this.closeGroup(),m=a.slice(1),x=et(m,0);if(x<m.length&&m[x]==="{"){const b=Mt(m,x);if(d.setAttributes(Et(b.blockText)),et(m,b.nextPos)<m.length)throw new Error(`Unexpected trailing content after ')': ${m}`)}else if(et(m,0)<m.length)throw new Error(`Unexpected trailing content after ')': ${m}`);a="";continue}const g=this.parseChainStatement(a);a=a.slice(g).trim()}n&&n.length>0&&this.pendingEdge&&(this.pendingEdge.fanoutSources=n);const p=this.graph.edges.length-w,y=c.length>0?c:n;if(y&&y.length>0&&p===1&&this.lastCreatedEdge){const g=this.lastCreatedEdge,d=this.graph.edges[this.graph.edges.length-1];f=y;for(const m of y){if(m===g.from)continue;const x=this.graph.addEdge(m,d.to,g.leftOp,g.rightOp,g.label);g.attrs&&x.setAttributes(g.attrs)}}p===1&&this.lastCreatedEdge&&this.lastChainNode?(l=[this.lastChainNode],h=this.lastParsedNodeAttrs?{...this.lastParsedNodeAttrs}:void 0):(l=[],h=void 0),c=[],n=void 0,r=this.lastCreatedEdge}l.length>0&&(this.lastNodeList=l)}tryParseScopeAttributes(e){const t=e.trim(),n=/^\.[A-Za-z0-9_-]/.test(t);if(t.startsWith("[")||t.startsWith("(")||be(t)&&!n)return!1;if(t.startsWith("{")&&t.endsWith("}"))return this.graph.setGraphAttributes(Et(t)),!0;const o=t.indexOf("{");if(o===-1||!t.endsWith("}"))return!1;const s=t.slice(0,o).trim(),r=t.slice(o).trim(),c=Et(r),f=Ue(s,",").map(l=>l.trim()).filter(Boolean);if(!f.length)return!1;for(const l of f){if(l.startsWith(".")){this.graph.setClassAttributes("node",l.slice(1),c);continue}const h=/^(graph|node|edge|group)(?:\.([A-Za-z0-9_-]+))?$/.exec(l);if(!h)return!1;const u=h[1],a=h[2];if(u==="graph"){this.graph.setGraphAttributes(c);continue}if(a){this.graph.setClassAttributes(u,a,c);continue}this.graph.setDefaultAttributes(u,c)}return!0}parseNodeAt(e,t){const n=Ee(e,t),o=n.blockText,s=Vo(o,!0);let r=n.nextPos;r=et(e,r);let c;if(r<e.length&&e[r]==="{"){const u=Mt(e,r);c=Et(u.blockText),r=u.nextPos}if(ze(s)){const u=this.autosplitNodes(s,c),a=this.currentGroup();if(a)for(const w of u)a.addNode(w);return{node:u[0],edgeNodes:u,nextPos:r,attrs:c}}let f=s.trim();f=f.replace(/\s+/g," "),f=f.replace(/\\\|/g,"|");let l;if(f===""){let u;do u=`#${this.nextAnonId++}`;while(this.graph.node(u));l=this.graph.addNode(u),l.label=" ",l.setAttributes({shape:"invisible"})}else l=this.graph.addNode(f);c&&l.setAttributes(c);const h=this.currentGroup();return h&&h.addNode(l),{node:l,edgeNodes:[l],nextPos:r,attrs:c}}parseGroupAt(e,t){const n=this.lastChainNode,o=qo(e,t),s=o.blockText;let r=-1;for(let w=0;w<s.length;w++){const p=s[w];if(p==="["||p==="("){r=w;break}}const c=(r===-1?s:s.slice(0,r)).trim(),f=(r===-1?"":s.slice(r)).trim(),l=this.openGroup(c),h=l.nodes.size;f&&this.parseLogicalLine(f);const u=l.nodes.size>h?this.lastChainNode:void 0;this.closeGroup(),u||(this.lastChainNode=n);let a=o.nextPos;if(a=et(e,a),a<e.length&&e[a]==="{"){const w=Mt(e,a);l.setAttributes(Et(w.blockText)),a=w.nextPos}return{repNode:u,nextPos:a}}parseEdgeSpec(e,t,n){let o;const s=y=>/[<>\-=.~]/.test(y),r=y=>y===" "||y==="	",c=(y,g)=>{if(g>=y.length||!s(y[g]))return;let d=g;for(;d<y.length;){const m=y[d];if(s(m)){d++;continue}if(r(m)){let x=d;for(;x<y.length&&r(y[x]);)x++;if(x<y.length&&s(y[x])){d=x;continue}}break}return{op:y.slice(g,d),nextPos:d}},f=(y,g)=>{if(g<=0)return;let d=g-1;for(;d>=0&&r(y[d]);)d--;if(d<0||!s(y[d]))return;for(;d>=0;){const x=y[d];if(s(x)){d--;continue}if(r(x)){let b=d;for(;b>=0&&r(y[b]);)b--;if(b>=0&&s(y[b])){d=b;continue}}break}const m=d+1;return{op:y.slice(m,g),startPos:m}},l=y=>{const g=y.trim();if(!g)throw new Error(`Missing edge operator in: ${e.slice(t,n)}`);const d=c(g,0);if(!d)throw new Error(`Missing edge operator in: ${e.slice(t,n)}`);if(d.nextPos>=g.length)return{leftOp:g,rightOp:g,label:""};const m=f(g,g.length);if(!m)throw new Error(`Missing edge operator in: ${e.slice(t,n)}`);if(m.startPos<=d.nextPos)return{leftOp:g,rightOp:g,label:""};const x=g.slice(d.nextPos,m.startPos).trim();return x?{leftOp:d.op,rightOp:m.op,label:x}:{leftOp:g,rightOp:g,label:""}};let h=n,u=t;for(;u<h;){if(e[u]==="{"){const g=Mt(e,u);o=Et(g.blockText);const d=e.slice(t,u),m=e.slice(g.nextPos,h),{leftOp:x,rightOp:b,label:k}=l(d+" "+m);return{leftOp:x,rightOp:b,label:k,attrs:o,nextPos:g.nextPos}}u++}const{leftOp:a,rightOp:w,label:p}=l(e.slice(t,n));return{leftOp:a,rightOp:w,label:p,nextPos:n}}findNextElementStart(e,t){let n=0,o=!1;for(let s=t;s<e.length;s++){const r=e[s];if(o){o=!1;continue}if(r==="\\"){o=!0;continue}if(r==="{"?n++:r==="}"&&n>0&&n--,n===0&&(r==="["||r==="("))return s}return-1}parseChainStatement(e){let t=et(e,0);if(t>=e.length)return e.length;let n,o=[];if(e[t]==="["){const s=this.parseNodeAt(e,t);n=s.node,o=s.edgeNodes,this.lastParsedNodeAttrs=s.attrs,t=s.nextPos,this.lastChainNode=n}else if(e[t]==="("){const s=this.parseGroupAt(e,t);n=s.repNode,o=n?[n]:[],t=s.nextPos,n&&(this.lastChainNode=n),this.lastParsedNodeAttrs=void 0}else if(be(e.slice(t))){if(!this.lastChainNode)throw new Error(`Edge continuation without a previous node: ${e}`);n=this.lastChainNode,o=[n],this.lastParsedNodeAttrs=void 0}else throw new Error(`Unsupported statement: ${e}`);for(;t=et(e,t),!(t>=e.length||e[t]==="["||e[t]==="("||e[t]===")");){const s=this.findNextElementStart(e,t),r=s===-1?e.length:s,c=this.parseEdgeSpec(e,t,r),f=c.leftOp,l=c.rightOp,h=c.label;if(s===-1)return n?(this.pendingEdge={from:n,leftOp:f,rightOp:l,label:h,attrs:c.attrs},e.length):(this.pendingEdge=void 0,e.length);let u,a=[],w;if(e[s]==="["){const p=this.parseNodeAt(e,s);u=p.node,a=p.edgeNodes,this.lastParsedNodeAttrs=p.attrs,w=p.nextPos}else{const p=this.parseGroupAt(e,s);u=p.repNode,a=u?[u]:[],this.lastParsedNodeAttrs=void 0,w=p.nextPos}if(o.length&&a.length){let p=!1;for(const y of o)for(const g of a){const d=this.graph.addEdge(y,g,f,l,h);c.attrs&&d.setAttributes(c.attrs),p||(this.lastCreatedEdge={from:y,leftOp:f,rightOp:l,label:h,attrs:c.attrs},p=!0)}}n=u,o=a,n&&(this.lastChainNode=n),t=w}return t}}class ue{static fromFile(e){const t=Ho(),n=Uo(),o=t.extname(e).toLowerCase(),s=n.readFileSync(e,"utf8");if(o===".dot"){const r=s.trimStart();return r.startsWith("(")||r.startsWith("[")?ue.fromText(s):Go(s)}return o===".gdl"?zo(s):ue.fromText(s)}static fromText(e){return new Jo().parse(e)}}const He=String.raw`# Minimal example
[ A ] --> [ B ]
[ B ] --> { label: ships } [ C ]
`;function F(i,e,t){if(i.textContent=t,e==="ok"){i.style.color="rgba(125,211,252,0.95)";return}if(e==="err"){i.style.color="rgba(251,113,133,0.95)";return}if(e==="busy"){i.style.color="rgba(167,139,250,0.95)";return}i.style.color="rgba(255,255,255,0.65)"}function Ko(i,e){let t;return(...n)=>{t!==void 0&&window.clearTimeout(t),t=window.setTimeout(()=>i(...n),e)}}function Zo(i,e){if(i===e)return"(exact match)";const t=i.replace(/\r\n?/g,`
`).split(`
`),n=e.replace(/\r\n?/g,`
`).split(`
`),o=Math.max(t.length,n.length),s=[];for(let r=0;r<o;r++){const c=t[r]??"",f=n[r]??"";c!==f&&(s.push(`L${String(r+1).padStart(3,"0")}: TS: ${c}`),s.push(`      PERL: ${f}`),s.push(""))}return s.join(`
`)}let z={kind:"loading"};async function Qo(i,e){if(typeof Perl>"u"){z={kind:"error",error:"WebPerl is not available (script failed to load)."},F(i,"err","webperl missing"),e.textContent=z.error;return}F(i,"busy","initializingâ¦"),await new Promise(c=>{Perl.init(()=>c())}),Perl.start(["-e","0"]),F(i,"busy","loading Graph::Easy modulesâ¦");const t=globalThis.FS;if(!t){z={kind:"error",error:"WebPerl initialized, but FS API is missing."},F(i,"err","fs missing"),e.textContent=z.error;return}const o=await fetch("/Graph-Easy-0.76/manifest.json");if(!o.ok){z={kind:"error",error:`Failed to load Graph::Easy manifest (${o.status} ${o.statusText})`},F(i,"err","manifest missing"),e.textContent=z.error;return}const s=await o.json(),r=c=>{if(typeof t.mkdirTree=="function"){t.mkdirTree(c);return}const f=c.split("/").filter(Boolean);let l="";for(const h of f){l+=`/${h}`;try{t.mkdir(l)}catch{}}};for(const c of s){const f=`/Graph-Easy-0.76/lib/${c}`,l=await fetch(f);if(!l.ok){z={kind:"error",error:`Failed to fetch ${f}`},F(i,"err","module fetch failed"),e.textContent=z.error;return}const h=await l.text(),u=`/Graph-Easy-0.76/lib/${c}`,a=u.split("/").slice(0,-1).join("/")||"/";r(a),t.writeFile(u,h)}z={kind:"ready"},F(i,"ok",`ready (${s.length} files)`)}function Xo(i){const e=performance.now(),t=ue.fromText(i);t.timeout=360,t.layout();const n=t.asAscii(),o=performance.now()-e;return{ascii:n,ms:o}}function Yo(i){if(z.kind!=="ready")throw z.kind==="error"?new Error(z.error):new Error("WebPerl is still initializing.");const e=globalThis.FS;if(!e)throw new Error("FS API is missing (unexpected after init).");try{e.mkdir("/tmp")}catch{}e.writeFile("/tmp/input.txt",i);const t=performance.now(),n=String.raw`
use lib '/Graph-Easy-0.76/lib';
use Graph::Easy::Parser;

my $out = eval {
  my $parser = Graph::Easy::Parser->new();
  my $txt = do { local $/; open my $fh, '<', '/tmp/input.txt' or die $!; <$fh> };
  my $graph = $parser->from_text($txt);
  $graph->layout();
  $graph->as_ascii();
};

if ($@) {
  "ERROR: $@";
} else {
  $out;
}
`;let o;try{o=String(Perl.eval(n)??"")}catch(r){if(String(r).toLowerCase().includes("state ended"))Perl.start(["-e","0"]),o=String(Perl.eval(n)??"");else throw r}const s=performance.now()-t;return{ascii:o,ms:s}}function ts(){const i=document.getElementById("input"),e=document.getElementById("btn-run"),t=document.getElementById("btn-reset"),n=document.getElementById("ts-output"),o=document.getElementById("perl-output"),s=document.getElementById("diff-output"),r=document.getElementById("ts-status"),c=document.getElementById("perl-status"),f=document.getElementById("diff-status");i.value=He;const l=()=>{const u=i.value;try{F(r,"busy","runningâ¦");const{ascii:w,ms:p}=Xo(u);n.textContent=w,F(r,"ok",`${p.toFixed(1)}ms`)}catch(w){const p=w instanceof Error?w.stack??w.message:String(w);n.textContent=p,F(r,"err","error")}let a="";try{if(z.kind!=="ready")F(c,z.kind==="error"?"err":"busy",z.kind),o.textContent=z.kind==="error"?z.error:"WebPerl is still initializingâ¦";else{F(c,"busy","runningâ¦");const{ascii:w,ms:p}=Yo(u);a=w,o.textContent=w,w.trimStart().startsWith("ERROR:")?F(c,"err","error"):F(c,"ok",`${p.toFixed(1)}ms`)}}catch(w){const p=w instanceof Error?w.stack??w.message:String(w);o.textContent=p,F(c,"err","error")}try{F(f,"busy","computingâ¦");const w=n.textContent??"",p=Zo(w,a||(o.textContent??""));s.textContent=p,F(f,"ok",p==="(exact match)"?"match":"diff")}catch(w){const p=w instanceof Error?w.stack??w.message:String(w);s.textContent=p,F(f,"err","error")}},h=Ko(l,150);Qo(c,o).then(()=>l()).catch(u=>{z={kind:"error",error:String(u)},F(c,"err","init failed"),o.textContent=String(u),l()}),i.addEventListener("input",h),e.addEventListener("click",l),t.addEventListener("click",()=>{i.value=He,l()}),l()}ts();
